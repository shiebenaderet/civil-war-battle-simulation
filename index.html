<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civil War Battle Simulation - Educational Edition</title>
    
    <!-- Performance & Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <!-- DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//upload.wikimedia.org">
    
    <!-- Asset Manifest - Public Domain Civil War Images -->
    <script type="application/json" id="assetManifest">[
        {
            "id": "bull_run",
            "title": "First Battle of Bull Run",
            "url": "images/battle_of_bull_run.jpg",
            "credit": "Currier & Ives",
            "license": "Public Domain",
            "source": "Library of Congress"
        },
        {
            "id": "shiloh",
            "title": "Battle of Shiloh",
            "url": "images/battle_of_shiloh.jpg",
            "credit": "Thure de Thulstrup",
            "license": "Public Domain",
            "source": "Library of Congress"
        },
        {
            "id": "antietam",
            "title": "Battle of Antietam",
            "url": "images/battle_of_antietam.jpg",
            "credit": "Alexander Gardner",
            "license": "Public Domain",
            "source": "National Archives"
        },
        {
            "id": "gettysburg",
            "title": "Battle of Gettysburg",
            "url": "images/battle_of_gettysburg.jpg",
            "credit": "Thure de Thulstrup",
            "license": "Public Domain",
            "source": "Library of Congress"
        },
        {
            "id": "fredericksburg",
            "title": "Battle of Fredericksburg",
            "url": "images/battle_of_fredericksburg.jpg",
            "credit": "Kurz & Allison",
            "license": "Public Domain",
            "source": "Library of Congress"
        },
        {
            "id": "chancellorsville", 
            "title": "Battle of Chancellorsville",
            "url": "images/battle_of_chancellorsville.jpg",
            "credit": "Jedediah Hotchkiss",
            "license": "Public Domain",
            "source": "National Archives"
        },
        {
            "id": "chickamauga",
            "title": "Battle of Chickamauga",
            "url": "images/battle_of_chickamauga.jpg",
            "credit": "Kurz & Allison",
            "license": "Public Domain",
            "source": "Library of Congress"
        },
        {
            "id": "wilderness",
            "title": "Battle of the Wilderness",
            "url": "images/battle_of_the_wilderness.jpg",
            "credit": "Kurz & Allison",
            "license": "Public Domain",
            "source": "Library of Congress"
        },
        {
            "id": "atlanta",
            "title": "Battle of Atlanta",
            "url": "images/battle_of_atlanta.jpg",
            "credit": "Kurz & Allison",
            "license": "Public Domain",
            "source": "Library of Congress"
        },
        {
            "id": "appomattox",
            "title": "Surrender at Appomattox",
            "url": "images/surrender_appomattox.jpg",
            "credit": "Tom Lovell",
            "license": "Public Domain",
            "source": "National Archives"
        }
    ]</script>
    
    <!-- Google Fonts - Optimized Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Crimson+Pro:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Crimson+Pro:wght@400;500;600&display=swap" rel="stylesheet"></noscript>
    
    <!-- Google Translate Integration -->
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'es,fr,pt,zh,ko,uk,ja,ru,ar',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
        }
        
        function translateWithGoogle(targetLanguage) {
            // Update HTML lang attribute
            updateLanguageAttribute(targetLanguage);
            
            const langCode = getLanguageCode(targetLanguage);
            
            // Load Google Translate if not already loaded
            if (!document.querySelector('script[src*="translate.google.com"]')) {
                const script = document.createElement('script');
                script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
                script.async = true;
                document.head.appendChild(script);
                
                script.onload = () => {
                    setTimeout(() => {
                        const select = document.querySelector('.goog-te-combo');
                        if (select) {
                            select.value = langCode;
                            select.dispatchEvent(new Event('change'));
                        }
                    }, 1000);
                };
            } else {
                // If already loaded, just change the language
                const select = document.querySelector('.goog-te-combo');
                if (select) {
                    select.value = langCode;
                    select.dispatchEvent(new Event('change'));
                }
            }
        }
        
        function getLanguageCode(language) {
            const languageCodes = {
                'Spanish': 'es',
                'French': 'fr',
                'Portuguese': 'pt',
                'Chinese': 'zh',
                'Korean': 'ko',
                'Ukrainian': 'uk',
                'Japanese': 'ja',
                'Russian': 'ru',
                'Arabic': 'ar'
            };
            return languageCodes[language] || 'en';
        }
        
        // Vocabulary Sidebar Toggle
        function toggleVocabSidebar() {
            const sidebar = document.getElementById('vocabSidebar');
            sidebar.classList.toggle('open');
        }
        
        // Theme Toggle Function
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update theme toggle button
            const toggleBtn = document.getElementById('themeToggle');
            if (toggleBtn) {
                toggleBtn.textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                toggleBtn.setAttribute('aria-label', `Switch to ${newTheme === 'light' ? 'dark' : 'light'} theme`);
            }
        }
        
        // Update HTML lang attribute for translation
        function updateLanguageAttribute(language) {
            const html = document.documentElement;
            const langCode = getLanguageCode(language);
            html.setAttribute('lang', langCode);
        }
        
        // Initialize theme on page load
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const html = document.documentElement;
            
            html.setAttribute('data-theme', savedTheme);
            
            const toggleBtn = document.getElementById('themeToggle');
            if (toggleBtn) {
                toggleBtn.textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                toggleBtn.setAttribute('aria-label', `Switch to ${savedTheme === 'light' ? 'dark' : 'light'} theme`);
            }
        }
    </script>
    
    <style>
        /* ===============================================
           DESIGN TOKENS - Contemporary Classroom Theme
           =============================================== */
        
        :root {
            /* Color Palette - Dark Theme (Default) */
            --color-navy-900: #0c0f17;
            --color-navy-800: #1a1d29;
            --color-navy-700: #252938;
            --color-navy-600: #363b4a;
            --color-navy-500: #4a5568;
            --color-navy-400: #718096;
            --color-navy-300: #a0aec0;
            --color-navy-200: #cbd5e0;
            --color-navy-100: #e2e8f0;
            --color-navy-50: #f7fafc;
            
            --color-gold-900: #744210;
            --color-gold-800: #975a16;
            --color-gold-700: #b7791f;
            --color-gold-600: #d4af37;
            --color-gold-500: #ecc94b;
            --color-gold-400: #f6e05e;
            --color-gold-300: #faf089;
            --color-gold-200: #fefcbf;
            --color-gold-100: #fffff0;
            
            --color-blue-900: #1e3a5f;
            --color-blue-800: #2c5282;
            --color-blue-700: #3182ce;
            --color-blue-600: #4a90a4;
            --color-blue-500: #63b3ed;
            --color-blue-400: #90cdf4;
            --color-blue-300: #bee3f8;
            --color-blue-200: #e6f7ff;
            
            --color-cream-900: #8d7053;
            --color-cream-800: #a0956b;
            --color-cream-700: #b8ad85;
            --color-cream-600: #d4c8a0;
            --color-cream-500: #e8dcc0;
            --color-cream-400: #f0e7d1;
            --color-cream-300: #f5f1e8;
            --color-cream-200: #faf8f3;
            --color-cream-100: #ffffff;
            
            /* Semantic Colors - Dark Theme */
            --color-primary: var(--color-gold-600);
            --color-primary-hover: var(--color-gold-500);
            --color-primary-active: var(--color-gold-700);
            
            --color-secondary: var(--color-blue-600);
            --color-secondary-hover: var(--color-blue-500);
            --color-secondary-active: var(--color-blue-700);
            
            --color-surface-primary: var(--color-navy-800);
            --color-surface-secondary: var(--color-navy-700);
            --color-surface-tertiary: var(--color-navy-600);
            --color-surface-elevated: var(--color-navy-600);
            
            --color-text-primary: var(--color-cream-300);
            --color-text-secondary: var(--color-navy-300);
            --color-text-tertiary: var(--color-navy-400);
            --color-text-inverse: var(--color-navy-900);
            
            --color-border-primary: var(--color-navy-500);
            --color-border-secondary: var(--color-navy-600);
            --color-border-accent: var(--color-primary);
            
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            --color-info: var(--color-blue-500);
            
            /* Spacing Scale */
            --space-0: 0;
            --space-1: 0.25rem;   /* 4px */
            --space-2: 0.5rem;    /* 8px */
            --space-3: 0.75rem;   /* 12px */
            --space-4: 1rem;      /* 16px */
            --space-5: 1.25rem;   /* 20px */
            --space-6: 1.5rem;    /* 24px */
            --space-8: 2rem;      /* 32px */
            --space-10: 2.5rem;   /* 40px */
            --space-12: 3rem;     /* 48px */
            --space-16: 4rem;     /* 64px */
            --space-20: 5rem;     /* 80px */
            --space-24: 6rem;     /* 96px */
            
            /* Border Radius */
            --radius-sm: 0.25rem;   /* 4px */
            --radius-md: 0.375rem;  /* 6px */
            --radius-lg: 0.5rem;    /* 8px */
            --radius-xl: 0.75rem;   /* 12px */
            --radius-2xl: 1rem;     /* 16px */
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-glow: 0 0 20px rgba(212, 175, 55, 0.3);
            --shadow-glow-strong: 0 0 30px rgba(212, 175, 55, 0.5);
            
            /* Font Families */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-serif: 'Crimson Pro', 'Times New Roman', serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            
            /* Typography Scale */
            --font-size-xs: clamp(0.75rem, 0.7rem + 0.2vw, 0.875rem);
            --font-size-sm: clamp(0.875rem, 0.8rem + 0.3vw, 1rem);
            --font-size-base: clamp(1rem, 0.9rem + 0.4vw, 1.125rem);
            --font-size-lg: clamp(1.125rem, 1rem + 0.5vw, 1.25rem);
            --font-size-xl: clamp(1.25rem, 1.1rem + 0.6vw, 1.5rem);
            --font-size-2xl: clamp(1.5rem, 1.3rem + 0.8vw, 1.875rem);
            --font-size-3xl: clamp(1.875rem, 1.6rem + 1vw, 2.25rem);
            --font-size-4xl: clamp(2.25rem, 1.9rem + 1.4vw, 3rem);
            --font-size-5xl: clamp(3rem, 2.5rem + 2vw, 4rem);
            
            /* Font Weights */
            --font-weight-light: 300;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            
            /* Line Heights */
            --leading-tight: 1.25;
            --leading-snug: 1.375;
            --leading-normal: 1.5;
            --leading-relaxed: 1.625;
            --leading-loose: 2;
            
            /* Z-Index Scale */
            --z-tooltip: 1000;
            --z-modal: 1100;
            --z-sidebar: 1200;
            --z-header: 1300;
            --z-overlay: 1400;
        }
        
        /* Light Theme Override */
        [data-theme="light"] {
            --color-surface-primary: var(--color-cream-200);
            --color-surface-secondary: var(--color-cream-100);
            --color-surface-tertiary: var(--color-cream-300);
            --color-surface-elevated: var(--color-cream-100);
            
            --color-text-primary: var(--color-navy-900);
            --color-text-secondary: var(--color-navy-700);
            --color-text-tertiary: var(--color-navy-600);
            --color-text-inverse: var(--color-cream-100);
            
            --color-border-primary: var(--color-navy-300);
            --color-border-secondary: var(--color-navy-200);
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.15), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.08);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.06);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.35);
        }
        
        /* Motion & Animation Tokens */
        :root {
            /* Transition Durations */
            --transition-fast: 0.15s;
            --transition-base: 0.2s;
            --transition-slow: 0.3s;
            --transition-slower: 0.5s;
            
            /* Transition Easings */
            --ease-in: cubic-bezier(0.4, 0, 1, 1);
            --ease-out: cubic-bezier(0, 0, 0.2, 1);
            --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-back: cubic-bezier(0.34, 1.56, 0.64, 1);
            --ease-elastic: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            /* Animation Durations */
            --animation-fast: 0.3s;
            --animation-base: 0.5s;
            --animation-slow: 0.8s;
            --animation-slower: 1.2s;
        }
        
        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            :root {
                --transition-fast: 0.01ms;
                --transition-base: 0.01ms;
                --transition-slow: 0.01ms;
                --transition-slower: 0.01ms;
                --animation-fast: 0.01ms;
                --animation-base: 0.01ms;
                --animation-slow: 0.01ms;
                --animation-slower: 0.01ms;
            }
            
            *,
            *::before,
            *::after {
                animation-duration: var(--animation-base) !important;
                animation-delay: var(--animation-base) !important;
                transition-duration: var(--transition-base) !important;
                transition-delay: var(--transition-base) !important;
                transform: none !important;
            }
            
            /* Disable parallax and auto-playing animations */
            .parallax,
            .auto-animate {
                animation: none !important;
                transform: none !important;
            }
        }
        
        /* ===============================================
           BASE STYLES
           =============================================== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-normal);
            line-height: var(--leading-normal);
            background-color: var(--color-surface-primary);
            color: var(--color-text-primary);
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)),
                repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,.02) 10px, rgba(255,255,255,.02) 20px);
        }
        
        /* ===============================================
           TYPOGRAPHY STYLES
           =============================================== */
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-serif);
            font-weight: var(--font-weight-semibold);
            line-height: var(--leading-tight);
            color: var(--color-text-primary);
            margin-bottom: var(--space-4);
        }
        
        h1 {
            font-size: var(--font-size-4xl);
            font-weight: var(--font-weight-bold);
        }
        
        h2 {
            font-size: var(--font-size-3xl);
        }
        
        h3 {
            font-size: var(--font-size-2xl);
        }
        
        h4 {
            font-size: var(--font-size-xl);
        }
        
        h5 {
            font-size: var(--font-size-lg);
        }
        
        h6 {
            font-size: var(--font-size-base);
        }
        
        /* Paragraphs and text */
        p {
            margin-bottom: var(--space-4);
            line-height: var(--leading-relaxed);
        }
        
        .text-serif {
            font-family: var(--font-serif);
        }
        
        .text-sans {
            font-family: var(--font-sans);
        }
        
        /* Text sizes */
        .text-xs { font-size: var(--font-size-xs); }
        .text-sm { font-size: var(--font-size-sm); }
        .text-base { font-size: var(--font-size-base); }
        .text-lg { font-size: var(--font-size-lg); }
        .text-xl { font-size: var(--font-size-xl); }
        .text-2xl { font-size: var(--font-size-2xl); }
        .text-3xl { font-size: var(--font-size-3xl); }
        
        /* Text weights */
        .font-light { font-weight: var(--font-weight-light); }
        .font-normal { font-weight: var(--font-weight-normal); }
        .font-medium { font-weight: var(--font-weight-medium); }
        .font-semibold { font-weight: var(--font-weight-semibold); }
        .font-bold { font-weight: var(--font-weight-bold); }
        
        /* Text colors */
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        .text-tertiary { color: var(--color-text-tertiary); }
        .text-accent { color: var(--color-primary); }
        
        /* ===============================================
           ACCESSIBILITY UTILITIES
           =============================================== */
        
        /* Skip Link - Hidden accessibility feature */
        .skip-link {
            position: absolute;
            top: -40px;
            left: var(--space-2);
            background: var(--color-primary);
            color: var(--color-text-inverse);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            text-decoration: none;
            font-family: var(--font-sans);
            font-weight: var(--font-weight-semibold);
            z-index: calc(var(--z-overlay) + 1);
            transition: all var(--transition-fast) var(--ease-out);
            /* Ensure it stays hidden unless focused */
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
        }
        
        .skip-link:focus,
        .skip-link:focus-visible {
            top: var(--space-2);
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        
        /* Screen Reader Only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .sr-only.focusable:active,
        .sr-only.focusable:focus {
            position: static;
            width: auto;
            height: auto;
            margin: 0;
            overflow: visible;
            clip: auto;
            white-space: normal;
        }
        
        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            :root {
                --color-text-primary: #000000;
                --color-text-secondary: #000000;
                --color-surface-primary: #ffffff;
                --color-surface-secondary: #ffffff;
                --color-border-primary: #000000;
                --color-border-secondary: #000000;
            }
            
            .side-card,
            .visual-toggle-btn,
            .proceed-btn,
            .back-btn {
                border: 2px solid #000000 !important;
            }
        }
        
        /* ===============================================
           ANIMATIONS & KEYFRAMES
           =============================================== */
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes slideInLeft {
            from { 
                opacity: 0; 
                transform: translateX(-30px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        @keyframes slideInRight {
            from { 
                opacity: 0; 
                transform: translateX(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        @keyframes scaleIn {
            from { 
                opacity: 0; 
                transform: scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
                opacity: 1;
            }
            50% { 
                transform: scale(1.05); 
                opacity: 0.8;
            }
        }
        
        @keyframes float {
            0%, 100% { 
                transform: translateY(0px); 
            }
            50% { 
                transform: translateY(-5px); 
            }
        }
        
        @keyframes shimmer {
            0% { 
                background-position: -200px 0; 
            }
            100% { 
                background-position: calc(200px + 100%) 0; 
            }
        }
        
        /* Animation utility classes */
        .animate-fade-in {
            animation: fadeIn var(--animation-base) var(--ease-out) forwards;
        }
        
        .animate-slide-in-left {
            animation: slideInLeft var(--animation-base) var(--ease-out) forwards;
        }
        
        .animate-slide-in-right {
            animation: slideInRight var(--animation-base) var(--ease-out) forwards;
        }
        
        .animate-scale-in {
            animation: scaleIn var(--animation-fast) var(--ease-back) forwards;
        }
        
        .animate-pulse {
            animation: pulse var(--animation-slow) ease-in-out infinite;
        }
        
        .animate-float {
            animation: float var(--animation-slower) ease-in-out infinite;
        }
        
        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--color-surface-secondary) 25%,
                var(--color-surface-elevated) 50%,
                var(--color-surface-secondary) 75%
            );
            background-size: 200px 100%;
            animation: shimmer var(--animation-base) ease-in-out infinite;
        }
        
        /* ===============================================
           Performance Optimizations
           =============================================== */
        
        /* Font loading optimization */
        @font-face {
            font-family: 'Inter';
            font-display: swap;
        }
        
        @font-face {
            font-family: 'Crimson Pro';
            font-display: swap;
        }
        
        /* GPU acceleration for animations */
        .side-selection,
        .battle-briefing,
        .side-introduction,
        .game-screen,
        .battle-results-modal,
        .campaign-log-modal,
        .end-game-summary {
            will-change: transform, opacity;
            contain: layout style;
        }
        
        /* Optimize frequently animated elements */
        .theme-toggle,
        .proceed-btn,
        .back-btn,
        .side-card,
        .strategy-option {
            will-change: transform;
            contain: layout;
        }
        
        /* Optimize images for performance */
        img {
            will-change: auto;
            contain: layout;
        }
        
        /* Reduce paint on scroll */
        .game-container {
            contain: layout style;
        }

        .game-container {
            width: 100%;
            max-width: 1000px;
            padding: var(--space-5);
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            padding-top: calc(80px + var(--space-6)); /* Account for fixed navbar */
        }
        
        /* ===============================================
           Main Navigation Bar
           =============================================== */
        
        .main-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--color-surface-elevated);
            border-bottom: 1px solid var(--color-border-secondary);
            z-index: var(--z-header);
            backdrop-filter: blur(8px);
            box-shadow: var(--shadow-sm);
        }
        
        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-3) var(--space-4);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
        }
        
        .navbar-brand {
            flex-shrink: 0;
        }
        
        .nav-game-title {
            margin: 0;
            font-family: var(--font-serif);
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--color-text-primary);
            line-height: 1.2;
        }
        
        .nav-subtitle {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            font-weight: 400;
        }
        
        .navbar-stats {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            flex: 1;
            justify-content: center;
        }
        
        .stat-item {
            font-size: var(--font-size-sm);
            padding: var(--space-2) var(--space-3);
            background: var(--color-surface-secondary);
            border-radius: var(--radius-lg);
            font-weight: 500;
            white-space: nowrap;
        }
        
        .stat-item span {
            color: var(--color-primary);
            font-weight: 600;
        }
        
        .navbar-controls {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            flex-shrink: 0;
        }
        
        .nav-btn {
            width: var(--space-10);
            height: var(--space-10);
            border: 1px solid var(--color-border-secondary);
            border-radius: var(--radius-lg);
            background: var(--color-surface-secondary);
            color: var(--color-text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-lg);
            transition: all var(--transition-base) var(--ease-out);
        }
        
        .nav-btn:hover {
            background: var(--color-surface-tertiary);
            border-color: var(--color-border-primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .nav-btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        .nav-btn:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }
        
        .primary-action {
            background: var(--color-primary-alpha) !important;
            border-color: var(--color-primary) !important;
        }
        
        .primary-action:hover {
            background: var(--color-primary) !important;
            color: white !important;
        }
        
        /* Settings Dropdown */
        .settings-dropdown {
            position: relative;
        }
        
        .settings-menu {
            position: absolute;
            top: calc(100% + var(--space-2));
            right: 0;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border-secondary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            min-width: 240px;
            max-width: 280px;
            padding: var(--space-1);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-base) var(--ease-out);
            z-index: var(--z-tooltip);
        }
        
        .settings-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .menu-section {
            margin: var(--space-1) 0;
        }
        
        .menu-section-title {
            font-size: var(--font-size-xs);
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: var(--space-2) var(--space-3) var(--space-1);
            margin: 0;
        }
        
        .settings-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            border: none;
            background: none;
            color: var(--color-text-primary);
            cursor: pointer;
            border-radius: var(--radius-lg);
            transition: background-color var(--transition-base) var(--ease-out);
            width: 100%;
            text-align: left;
            font-size: var(--font-size-sm);
            position: relative;
        }
        
        .menu-icon {
            font-size: var(--font-size-base);
            width: 20px;
            text-align: center;
        }
        
        .menu-status {
            margin-left: auto;
            font-size: var(--font-size-xs);
            font-weight: 600;
            padding: 2px 6px;
            border-radius: var(--radius-md);
            background: var(--color-surface-secondary);
            color: var(--color-text-secondary);
        }
        
        .menu-status.active {
            background: var(--color-primary);
            color: white;
        }
        
        .translate-item {
            padding: var(--space-2) var(--space-3);
        }
        
        .settings-item:hover {
            background: var(--color-surface-secondary);
        }
        
        .settings-item:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 1px;
        }
        
        .settings-divider {
            height: 1px;
            background: var(--color-border-secondary);
            margin: var(--space-2) 0;
        }
        
        .translate-label {
            font-weight: 500;
            color: var(--color-text-secondary);
        }
        
        .translate-select-nav {
            background: var(--color-surface-secondary);
            border: 1px solid var(--color-border-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-1) var(--space-2);
            color: var(--color-text-primary);
            font-size: var(--font-size-sm);
            cursor: pointer;
        }
        
        .danger-item {
            color: var(--color-red-600);
        }
        
        .danger-item:hover {
            background: var(--color-red-50);
            color: var(--color-red-700);
        }
        
        .theme-toggle-item {
            justify-content: flex-start;
        }
        
        .theme-icon {
            font-size: var(--font-size-lg);
        }

        /* ===============================================
           VOCABULARY SIDEBAR
           =============================================== */
        
        /* Body state when vocabulary sidebar is open */
        body.vocab-open {
            overflow-x: hidden;
        }
        
        body.vocab-open .main-navbar,
        body.vocab-open .game-container {
            transform: translateX(280px);
            transition: transform var(--transition-slow) var(--ease-out);
        }
        
        .vocab-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--color-surface-primary);
            border-right: 2px solid var(--color-border-primary);
            padding: var(--space-5);
            z-index: var(--z-sidebar);
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform var(--transition-slow) var(--ease-out);
            box-shadow: var(--shadow-2xl);
            backdrop-filter: blur(10px);
        }
        
        .vocab-sidebar.show {
            transform: translateX(0);
        }
        
        /* Overlay for mobile */
        .vocab-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-base) var(--ease-out);
            z-index: calc(var(--z-sidebar) - 1);
        }
        
        .vocab-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .vocab-sidebar h3 {
            font-family: var(--font-serif);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
            margin-bottom: var(--space-5);
            text-align: center;
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: var(--space-3);
        }
        
        .vocab-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .vocab-item {
            margin-bottom: var(--space-4);
            padding: var(--space-3);
            background: var(--color-surface-elevated);
            border-radius: var(--radius-lg);
            border-left: 3px solid var(--color-primary);
            box-shadow: var(--shadow-sm);
        }
        
        .vocab-term-name {
            font-family: var(--font-serif);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-base);
            color: var(--color-primary);
            margin-bottom: var(--space-2);
        }
        
        .vocab-definition-text {
            font-family: var(--font-sans);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            line-height: var(--leading-relaxed);
        }
        
        .vocab-toggle-btn {
            position: fixed;
            left: var(--space-5);
            top: var(--space-5);
            background: linear-gradient(135deg, var(--color-primary), var(--color-warning));
            color: var(--color-text-inverse);
            border: none;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-family: var(--font-sans);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            z-index: var(--z-header);
            box-shadow: var(--shadow-glow);
            transition: all var(--transition-base) var(--ease-back);
        }
        
        .vocab-toggle-btn:hover {
            transform: scale(1.1) rotate(3deg);
            box-shadow: var(--shadow-glow-strong);
        }
        
        .vocab-toggle-btn:active {
            transform: scale(0.95) rotate(-2deg);
            transition-duration: var(--transition-fast);
        }
        
        .vocab-toggle-btn:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        /* ===============================================
           CONTROL PANELS
           =============================================== */
        
        .controls-panel {
            position: fixed;
            bottom: var(--space-5);
            right: var(--space-5);
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border-secondary);
            border-radius: var(--radius-xl);
            padding: var(--space-3);
            z-index: var(--z-tooltip);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            align-items: center;
            max-width: 200px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
        }

        /* Translation Controls */
        .translate-select {
            background: var(--color-surface-tertiary);
            border: 1px solid var(--color-border-primary);
            color: var(--color-text-primary);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            font-family: var(--font-sans);
            font-size: var(--font-size-sm);
            transition: all 0.2s ease;
        }
        
        .translate-select:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }
        
        .translate-select option {
            background: var(--color-surface-primary);
            color: var(--color-text-primary);
        }

        .vocab-toggle {
            background: linear-gradient(135deg, var(--color-success), var(--color-info));
            color: var(--color-text-inverse);
            border: none;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            transition: all 0.2s ease;
        }

        .vocab-toggle:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .vocab-toggle:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        .vocab-toggle.active {
            background: linear-gradient(135deg, var(--color-primary), var(--color-warning));
            color: var(--color-text-inverse);
        }

        /* Screen Display Management */
        .side-selection {
            display: block;
            text-align: center;
            animation: fadeIn var(--animation-base) var(--ease-out);
            width: 100%;
        }

        .side-introduction,
        .game-screen,
        .battle-briefing,
        .battle-results-modal,
        .campaign-log-modal,
        .end-game-summary {
            display: none;
        }
        
        /* Override for when sections are explicitly shown via inline styles */
        section[style*="display: block"],
        div[style*="display: block"] {
            display: block !important;
        }
        
        /* Specific overrides for game screen elements */
        #sideSelection[style*="display: block"],
        #battleBriefing[style*="display: block"],
        #gameScreen[style*="display: block"],
        #sideIntroduction[style*="display: block"],
        #endGameSummary[style*="display: block"] {
            display: block !important;
        }

        .game-title {
            font-family: var(--font-serif);
            font-size: var(--font-size-4xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-3);
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
            background: linear-gradient(45deg, var(--color-gold-800), var(--color-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: var(--leading-tight);
        }

        .subtitle {
            font-family: var(--font-serif);
            font-size: var(--font-size-lg);
            font-style: italic;
            margin-bottom: var(--space-10);
            color: var(--color-text-secondary);
            line-height: var(--leading-normal);
        }

        /* Vocabulary Support */
        .vocab-term {
            border-bottom: 2px dotted var(--color-primary);
            cursor: help;
            transition: all 0.2s ease;
            position: relative;
            display: inline-block;
        }

        .vocab-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: #fff !important;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            width: 280px;
            text-align: left;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1100;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            border: 1px solid #444;
            margin-bottom: 10px;
            white-space: normal;
        }

        .vocab-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: #1a1a1a;
        }

        .vocab-term:hover .vocab-tooltip,
        .vocab-term:focus .vocab-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .vocab-definition {
            margin: 0;
            padding: 0;
            color: #f0f0f0 !important;
            font-size: inherit;
            line-height: 1.4;
        }


        /* Side Cards */
        /* ===============================================
           RESPONSIVE GRID LAYOUTS
           =============================================== */
        
        .sides-container {
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: var(--space-6);
            max-width: 800px;
            margin: 0 auto;
            flex-wrap: wrap;
        }
        
        .side-card {
            flex: 1;
            min-width: 320px;
            max-width: 380px;
        }
        
        @media (max-width: 640px) {
            .sides-container {
                flex-direction: column;
                gap: var(--space-4);
                align-items: center;
            }
            
            .side-card {
                width: 100%;
                max-width: 350px;
                min-width: auto;
                flex: none;
            }
            
            .visual-toggle-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .visual-toggle-btn {
                width: 100%;
                max-width: 200px;
            }
            
            .battle-visual-container {
                margin: var(--space-4) auto;
            }
        }

        /* ===============================================
           CARD COMPONENTS
           =============================================== */
        
        .side-card {
            background: var(--color-surface-elevated);
            border: 2px solid transparent;
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            cursor: pointer;
            transition: all var(--transition-base) var(--ease-out);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .side-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-2xl);
        }
        
        .side-card:active {
            transform: translateY(-1px) scale(0.98);
            transition-duration: var(--transition-fast);
        }
        
        .side-card:focus-within {
            outline: 3px solid var(--color-primary);
            outline-offset: 2px;
        }

        .union-card {
            border-color: #1e3a8a;
            background: linear-gradient(135deg, rgba(30,58,138,0.2), rgba(59,130,246,0.1));
        }

        .union-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 10px 30px rgba(59,130,246,0.3);
        }

        .confederacy-card {
            border-color: #7f1d1d;
            background: linear-gradient(135deg, rgba(127,29,29,0.2), rgba(220,38,38,0.1));
        }

        .confederacy-card:hover {
            border-color: #dc2626;
            box-shadow: 0 10px 30px rgba(220,38,38,0.3);
        }

        .side-flag {
            font-size: 4em;
            margin-bottom: 20px;
            display: block;
        }

        .side-name {
            font-size: 1.8em;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .side-description {
            font-size: 1em;
            line-height: 1.5;
            color: #ccc;
            margin-bottom: 15px;
        }

        .soldier-count {
            font-size: 1.1em;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .victory-condition {
            font-size: 0.9em;
            color: #ffd700;
            font-style: italic;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }

        /* Side Introduction */
        .side-introduction {
            text-align: center;
            animation: fadeIn 0.5s ease-out;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .leader-message {
            background: rgba(0,0,0,0.5);
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .leader-portrait {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
            border: 3px solid #ffd700;
        }

        .leader-name {
            font-size: 1.5em;
            color: #ffd700;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .message-text {
            font-size: 1.1em;
            line-height: 1.8;
            color: #f0f0f0;
            font-style: italic;
            text-align: left;
            max-width: 700px;
            margin: 0 auto 30px;
            white-space: pre-line;
        }

        .war-objectives {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .objectives-title {
            font-size: 1.3em;
            color: #ffd700;
            margin-bottom: 20px;
        }

        .objective-item {
            text-align: left;
            margin: 15px 0;
            padding-left: 30px;
            position: relative;
            font-size: 1.05em;
            line-height: 1.6;
        }

        .objective-item::before {
            content: '‚öîÔ∏è';
            position: absolute;
            left: 0;
            top: 0;
        }

        /* Battle Briefing Screen */
        .battle-briefing {
            text-align: center;
            animation: fadeIn 0.5s ease-out;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Desktop two-column layout - ONLY for battle briefing screen on large screens */
        @media (min-width: 1200px) and (min-height: 700px) {
            .battle-briefing {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto;
                gap: var(--space-4);
                align-items: start;
                text-align: left;
                padding: var(--space-4);
                min-height: calc(100vh - 100px);
                /* Remove height constraints that cause overflow issues */
            }
            
            .battle-briefing .briefing-header {
                grid-column: 1 / -1;
                text-align: center;
                margin-bottom: var(--space-2);
            }
            
            .battle-briefing .briefing-header h2 {
                margin-bottom: var(--space-2);
                font-size: var(--font-size-2xl);
            }
            
            .battle-briefing .battle-context {
                grid-column: 1;
                height: fit-content;
                padding-right: var(--space-2);
                /* Allow natural height without restrictions */
            }
            
            .battle-briefing .strategic-choices {
                grid-column: 2;
                height: fit-content;
                display: block;
                visibility: visible;
                /* Ensure all choices are always visible */
                overflow: visible;
            }
            
            /* Compact choice options for better screen fit */
            .battle-briefing .choice-option {
                margin: var(--space-2) 0;
                padding: var(--space-3);
            }
            
            /* Compact strategic choices header */
            .battle-briefing .choices-title {
                font-size: 1.2em;
                margin-bottom: var(--space-3);
            }
            
            /* Reduce spacing in battle context */
            .battle-briefing .battle-context p {
                margin-bottom: var(--space-3);
            }
            
            .battle-briefing .battle-context h3 {
                margin-bottom: var(--space-2);
                font-size: var(--font-size-lg);
            }
        }
        
        /* Ensure mobile/tablet view stays single column */
        @media (max-width: 1199px) {
            .battle-briefing {
                display: block;
                max-height: none;
                overflow: visible;
                text-align: center;
            }
        }

        .briefing-header {
            margin-bottom: 30px;
        }

        .briefing-title {
            font-size: 2.2em;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .briefing-date {
            font-size: 1.1em;
            color: #ccc;
            font-style: italic;
        }

        .battle-context {
            background: rgba(0,0,0,0.5);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: left;
        }

        .context-title {
            font-size: 1.4em;
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
        }

        .context-text {
            font-size: 1.1em;
            line-height: 1.7;
            margin-bottom: 20px;
        }

        /* ===============================================
           BATTLE VISUALS & MAPS
           =============================================== */
        
        .battle-visual-container {
            width: 100%;
            max-width: 600px;
            margin: var(--space-5) auto;
        }
        
        @media (min-width: 1024px) {
            .battle-visual-container {
                max-width: 100%;
                margin: var(--space-4) 0;
            }
        }
        
        .visual-toggle-controls {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
            justify-content: center;
        }
        
        .visual-toggle-btn {
            background: var(--color-surface-tertiary);
            border: 1px solid var(--color-border-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-2) var(--space-4);
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            transition: all var(--transition-base) var(--ease-out);
        }
        
        .visual-toggle-btn:hover {
            background: var(--color-surface-elevated);
            color: var(--color-text-primary);
            transform: translateY(-2px) scale(1.03);
        }
        
        .visual-toggle-btn:active {
            transform: translateY(0) scale(0.97);
            transition-duration: var(--transition-fast);
        }
        
        .visual-toggle-btn:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }
        
        .visual-toggle-btn.active {
            background: var(--color-primary);
            color: var(--color-text-inverse);
            border-color: var(--color-primary);
            box-shadow: var(--shadow-glow);
            transform: scale(1.05);
        }
        
        .visual-toggle-btn.active:hover {
            transform: translateY(-2px) scale(1.08);
            box-shadow: var(--shadow-glow-strong);
        }

        .battle-image {
            width: 100%;
            height: 300px;
            background: var(--color-surface-secondary);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .battle-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-xl);
        }
        
        .battle-map {
            width: 100%;
            height: 300px;
            background: var(--color-surface-secondary);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }
        
        .battle-map svg {
            width: 100%;
            height: 100%;
            background: var(--color-cream-200);
        }
        
        [data-theme="dark"] .battle-map svg {
            background: var(--color-navy-800);
        }

        .image-credit {
            position: absolute;
            bottom: var(--space-2);
            right: var(--space-3);
            background: rgba(0,0,0,0.8);
            color: var(--color-cream-200);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-family: var(--font-sans);
            backdrop-filter: blur(4px);
        }

        .strategic-choices {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            /* Ensure strategic choices are always visible */
            min-height: 200px;
            display: block !important;
            visibility: visible !important;
            overflow: visible !important;
            height: auto !important;
            max-height: none !important;
        }

        .choices-title {
            font-size: 1.4em;
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Ensure choicesList container is visible */
        #choicesList {
            display: block !important;
            visibility: visible !important;
            min-height: 100px;
            overflow: visible !important;
            height: auto !important;
        }

        .choice-option {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            /* Ensure choice options are visible */
            display: block !important;
            visibility: visible !important;
            min-height: 60px;
        }

        .choice-option:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .choice-option.aggressive {
            border-color: rgba(220,38,38,0.5);
        }

        .choice-option.defensive {
            border-color: rgba(59,130,246,0.5);
        }

        .choice-option.tactical {
            border-color: rgba(168,85,247,0.5);
        }

        .choice-option:hover.aggressive {
            border-color: #dc2626;
            box-shadow: 0 5px 15px rgba(220,38,38,0.2);
        }

        .choice-option:hover.defensive {
            border-color: #3b82f6;
            box-shadow: 0 5px 15px rgba(59,130,246,0.2);
        }

        .choice-option:hover.tactical {
            border-color: #a855f7;
            box-shadow: 0 5px 15px rgba(168,85,247,0.2);
        }

        .choice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .choice-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        .expand-icon {
            font-size: 1.2em;
            color: #ffd700;
            transition: transform 0.3s ease;
        }

        .choice-option.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .choice-description {
            font-size: 1em;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .choice-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
            opacity: 0;
        }

        .choice-option.expanded .choice-details {
            max-height: 500px;
            opacity: 1;
            margin-top: 15px;
        }

        .choice-explanation {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.95em;
            color: #ccc;
            border-left: 3px solid #ffd700;
            margin-bottom: 15px;
        }

        .choice-pros-cons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .pros, .cons {
            font-size: 0.9em;
        }

        .pros-title {
            color: #10b981;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .cons-title {
            color: #ef4444;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .pros ul, .cons ul {
            padding-left: 15px;
            margin: 0;
        }

        .pros li {
            color: #10b981;
            margin: 3px 0;
        }

        .cons li {
            color: #ef4444;
            margin: 3px 0;
        }

        .click-to-expand {
            text-align: center;
            color: #888;
            font-size: 0.9em;
            font-style: italic;
            margin-top: 20px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
        }

        /* Buttons */
        /* ===============================================
           BUTTON COMPONENTS
           =============================================== */
        
        .proceed-btn, .back-btn {
            padding: var(--space-4) var(--space-12);
            font-size: var(--font-size-xl);
            border: none;
            border-radius: var(--radius-xl);
            cursor: pointer;
            font-family: var(--font-serif);
            font-weight: var(--font-weight-semibold);
            transition: all var(--transition-base) var(--ease-out);
            margin: var(--space-3);
            position: relative;
            overflow: hidden;
        }
        

        .proceed-btn {
            background: linear-gradient(135deg, var(--color-primary), var(--color-warning));
            color: var(--color-text-inverse);
            box-shadow: var(--shadow-lg);
        }

        .proceed-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: var(--shadow-glow-strong);
        }
        
        .proceed-btn:active {
            transform: translateY(-1px) scale(0.98);
            transition-duration: var(--transition-fast);
        }
        
        .proceed-btn:focus {
            outline: 3px solid var(--color-primary);
            outline-offset: 2px;
        }

        .back-btn {
            background: var(--color-surface-tertiary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border-primary);
            box-shadow: var(--shadow-md);
        }

        .back-btn:hover {
            background: var(--color-surface-elevated);
            transform: translateX(-3px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }
        
        .back-btn:active {
            transform: translateX(-1px) scale(0.98);
            transition-duration: var(--transition-fast);
        }
        
        .back-btn:focus {
            outline: 3px solid var(--color-secondary);
            outline-offset: 2px;
        }

        /* Game Screen */
        .game-screen {
            animation: fadeIn 0.5s ease-out;
            width: 100%;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-stat {
            font-size: 1.1em;
            padding: 10px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            text-align: center;
        }

        .header-stat span {
            font-weight: bold;
            color: #ffd700;
        }

        .start-over-btn {
            padding: 10px 20px;
            font-size: 1em;
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Georgia', serif;
        }

        .start-over-btn:hover {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220,38,38,0.3);
        }

        .campaign-log-btn {
            padding: 10px 15px;
            font-size: 1em;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Georgia', serif;
            font-weight: bold;
        }

        .campaign-log-btn:hover {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139,92,246,0.3);
        }

        /* Campaign Log Modal */
        /* ===============================================
           MODAL COMPONENTS
           =============================================== */
        
        .campaign-log-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: var(--z-modal);
            overflow-y: auto;
            padding: var(--space-5);
            backdrop-filter: blur(8px);
        }

        .campaign-log-container {
            background: var(--color-surface-primary);
            border: 1px solid var(--color-border-secondary);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            max-width: 900px;
            width: 90%;
            margin: var(--space-10) auto;
            animation: fadeIn 0.5s ease-out;
            box-shadow: var(--shadow-2xl);
            position: relative;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
        }

        .log-title {
            font-size: 2em;
            color: #ffd700;
            margin: 0;
        }

        .close-log-btn {
            font-size: var(--font-size-2xl);
            background: var(--color-surface-tertiary);
            border: 1px solid var(--color-border-primary);
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: var(--space-2);
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            transition: all var(--transition-base) var(--ease-back);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-log-btn:hover {
            color: var(--color-text-primary);
            background: var(--color-surface-elevated);
            transform: scale(1.2) rotate(90deg);
        }
        
        .close-log-btn:active {
            transform: scale(0.9) rotate(180deg);
            transition-duration: var(--transition-fast);
        }
        
        .close-log-btn:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        .campaign-overview {
            margin-bottom: 30px;
        }

        .progress-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .summary-stat {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .summary-stat:hover {
            transform: translateY(-3px);
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #ccc;
            font-size: 0.9em;
        }

        .victory-progress {
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 10px;
        }

        .progress-title {
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
        }

        .victory-bar {
            position: relative;
            height: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            overflow: hidden;
        }

        .victory-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc2626, #10b981);
            transition: width 0.5s ease;
            border-radius: 15px;
        }

        .victory-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .battle-timeline {
            margin-bottom: 30px;
        }

        .timeline-title {
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
        }

        .timeline-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .timeline-item {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }

        .timeline-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        .timeline-item.victory {
            border-left-color: #10b981;
        }

        .timeline-item.defeat {
            border-left-color: #dc2626;
        }

        .timeline-battle {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .timeline-details {
            color: #ccc;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .strategy-analysis {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
        }

        .analysis-title {
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
        }

        .strategy-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .strategy-type {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .strategy-name {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 8px;
        }

        .strategy-count {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .strategy-success {
            font-size: 0.9em;
            color: #ccc;
        }

        /* Battle Results Modal */
        .battle-results-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1100;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
        }

        .battle-results-container {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            max-width: 700px;
            width: 90%;
            animation: fadeIn 0.5s ease-out;
            margin: 20px auto;
            min-height: fit-content;
        }

        /* Ensure all content is visible */
        .battle-results-modal.show {
            align-items: flex-start;
            padding-top: 20px;
        }

        .battle-outcome {
            font-size: 3em;
            margin-bottom: 20px;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
            padding: 15px 30px;
            border-radius: 10px;
            margin: 20px auto;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .battle-victory {
            color: white;
            background: linear-gradient(135deg, #10b981, #059669);
            border: 3px solid #10b981;
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.6);
            animation: victoryGlow 2s ease-in-out infinite;
        }

        .battle-defeat {
            color: white;
            background: linear-gradient(135deg, #dc2626, #991b1b);
            border: 3px solid #dc2626;
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.6);
            animation: defeatPulse 2s ease-in-out infinite;
        }

        @keyframes victoryGlow {
            0%, 100% { 
                box-shadow: 0 0 30px rgba(16, 185, 129, 0.6);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 40px rgba(16, 185, 129, 0.8);
                transform: scale(1.02);
            }
        }

        @keyframes defeatPulse {
            0%, 100% { 
                box-shadow: 0 0 30px rgba(220, 38, 38, 0.6);
                opacity: 1;
            }
            50% { 
                box-shadow: 0 0 20px rgba(220, 38, 38, 0.4);
                opacity: 0.8;
            }
        }

        /* Results Summary Styles */
        .results-summary {
            background: rgba(0,0,0,0.5);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid rgba(255,215,0,0.3);
        }

        .result-card {
            text-align: center;
            margin-bottom: 20px;
        }

        .result-icon {
            font-size: 3em;
            margin-bottom: 10px;
            animation: bounceIn 0.6s ease-out;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        .result-text {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 15px;
        }

        .impact-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .impact-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .impact-label {
            font-weight: bold;
            color: #ccc;
        }

        .impact-value {
            font-size: 1.1em;
            font-weight: bold;
        }

        .impact-value.casualties {
            color: #ef4444;
        }

        .impact-value.points {
            color: #10b981;
        }

        .impact-value.soldiers {
            color: #ffd700;
        }

        /* Outcome Highlights */
        .outcome-highlight {
            display: inline-block;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 10px 0;
            animation: highlightPulse 2s ease-in-out infinite;
        }

        .victory-highlight {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: 2px solid #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }

        .defeat-highlight {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            border: 2px solid #dc2626;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.4);
        }

        @keyframes highlightPulse {
            0%, 100% { 
                transform: scale(1); 
                opacity: 1;
            }
            50% { 
                transform: scale(1.05); 
                opacity: 0.9;
            }
        }

        .battle-explanation {
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 25px;
            margin: 25px 0;
            text-align: left;
        }

        .explanation-title {
            font-size: 1.4em;
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
        }

        .explanation-text {
            font-size: 1.05em;
            line-height: 1.7;
            margin-bottom: 20px;
        }

        .historical-note {
            background: rgba(255,215,0,0.1);
            border-left: 4px solid #ffd700;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .historical-note-title {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .continue-battle-btn {
            padding: 15px 50px;
            font-size: 1.2em;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 30px;
            margin-bottom: 10px;
        }

        .continue-battle-btn:hover {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(37,99,235,0.4);
        }

        /* End Game Summary */
        .end-game-summary {
            text-align: center;
            animation: fadeIn 0.5s ease-out;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .outcome-banner {
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .victory-banner {
            background: linear-gradient(135deg, #059669, #10b981);
            box-shadow: 0 10px 30px rgba(16,185,129,0.3);
        }

        .defeat-banner {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            box-shadow: 0 10px 30px rgba(220,38,38,0.3);
        }

        .outcome-title {
            font-size: 3em;
            margin-bottom: 10px;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            color: white;
        }

        .outcome-subtitle {
            font-size: 1.3em;
            font-style: italic;
            color: rgba(255,255,255,0.9);
        }

        .final-stats-container {
            background: rgba(0,0,0,0.5);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .play-again-btn {
            padding: 15px 40px;
            font-size: 1.2em;
            background: linear-gradient(135deg, #ffd700, #f59e0b);
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .play-again-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(245,158,11,0.4);
        }

        @media (max-width: 700px) {
            .game-container { 
                padding: var(--space-3); 
                padding-left: var(--space-5); 
            }
            .game-title { 
                font-size: var(--font-size-3xl); 
            }
            .side-card { width: 100%; max-width: 350px; }
            .sides-container { 
                flex-direction: column;
                gap: var(--space-4);
                align-items: center;
            }
            .controls-panel { position: relative; bottom: auto; right: auto; margin: 20px auto; max-width: 90%; }
            .choice-pros-cons { grid-template-columns: 1fr; }
            .vocab-tooltip { width: 250px; }
            
            /* Mobile vocabulary sidebar - use overlay instead of push */
            .vocab-sidebar {
                width: 90vw;
                max-width: 300px;
            }
            
            /* On mobile, don't push content - use overlay */
            body.vocab-open .main-navbar,
            body.vocab-open .game-container {
                transform: none;
            }
            
            /* Mobile navigation adjustments */
            .navbar-content {
                padding: var(--space-2) var(--space-3);
                gap: var(--space-2);
                flex-wrap: wrap;
            }
            
            .nav-game-title {
                font-size: var(--font-size-lg);
            }
            
            .nav-subtitle {
                display: none; /* Hide subtitle on small screens */
            }
            
            .navbar-stats {
                gap: var(--space-1);
                order: 3;
                width: 100%;
                justify-content: center;
                margin-top: var(--space-2);
            }
            
            .stat-item {
                padding: var(--space-1) var(--space-2);
                font-size: var(--font-size-xs);
            }
            
            .nav-btn {
                width: var(--space-8);
                height: var(--space-8);
                font-size: var(--font-size-base);
            }
            
            .settings-menu {
                right: -10px;
                min-width: 180px;
            }
            
            .vocab-toggle-btn {
                left: 10px;
                top: 10px;
                padding: 10px 12px;
                font-size: 0.9em;
            }
            
            /* Mobile responsive for Civil War intro */
            .civil-war-intro .intro-content > div[style*="grid"] {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            .battle-results-container {
                padding: 20px;
                margin: 10px;
                width: 95%;
            }
            
            .battle-outcome {
                font-size: 2.2em;
                padding: 10px 20px;
            }
            
            .outcome-highlight {
                font-size: 1em;
                padding: 10px 15px;
            }
        }

        /* Stage 8: Print View - Clean educational handouts for classroom use */
        @media print {
            /* Reset colors and backgrounds for ink efficiency */
            * {
                background: white !important;
                color: black !important;
                text-shadow: none !important;
                box-shadow: none !important;
            }

            /* Page setup */
            @page {
                margin: 0.75in;
                size: letter;
            }

            /* Hide interactive elements */
            .controls-panel,
            .proceed-btn,
            .back-btn,
            .choice-option button,
            .translate-select,
            .vocab-button,
            #vocabSidebar,
            .click-to-expand {
                display: none !important;
            }

            /* Layout adjustments */
            body {
                font-family: Georgia, 'Times New Roman', serif !important;
                font-size: 12pt !important;
                line-height: 1.4 !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .game-container {
                max-width: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            /* Typography hierarchy for print */
            h1 {
                font-size: 18pt !important;
                font-weight: bold !important;
                text-align: center !important;
                margin-bottom: 12pt !important;
                page-break-after: avoid !important;
            }

            h2 {
                font-size: 16pt !important;
                font-weight: bold !important;
                margin: 12pt 0 6pt 0 !important;
                page-break-after: avoid !important;
            }

            h3 {
                font-size: 14pt !important;
                font-weight: bold !important;
                margin: 10pt 0 4pt 0 !important;
                page-break-after: avoid !important;
            }

            /* Battle content formatting */
            .battle-content {
                page-break-inside: avoid !important;
                margin-bottom: 18pt !important;
            }

            .battle-title {
                border-bottom: 2pt solid black !important;
                padding-bottom: 6pt !important;
                margin-bottom: 12pt !important;
            }

            .battle-info {
                margin-bottom: 12pt !important;
            }

            .battle-description {
                text-align: justify !important;
                margin-bottom: 12pt !important;
                line-height: 1.5 !important;
            }

            /* Choice options for print */
            .choice-option {
                border: 1pt solid black !important;
                margin: 6pt 0 !important;
                padding: 8pt !important;
                page-break-inside: avoid !important;
            }

            .choice-title {
                font-weight: bold !important;
                margin-bottom: 4pt !important;
            }

            .choice-details {
                max-height: none !important;
                opacity: 1 !important;
                overflow: visible !important;
                margin-top: 8pt !important;
            }

            .choice-explanation {
                background: #f5f5f5 !important;
                border-left: 3pt solid black !important;
                padding: 6pt !important;
                margin-bottom: 8pt !important;
            }

            .choice-pros-cons {
                display: block !important;
                margin-top: 8pt !important;
            }

            .pros, .cons {
                margin-bottom: 8pt !important;
            }

            .pros-title, .cons-title {
                font-weight: bold !important;
                text-decoration: underline !important;
                margin-bottom: 4pt !important;
            }

            /* Historical notes formatting */
            .historical-note {
                background: #f8f8f8 !important;
                border: 1pt solid #ccc !important;
                padding: 8pt !important;
                margin: 12pt 0 !important;
                page-break-inside: avoid !important;
            }

            .historical-note strong {
                font-weight: bold !important;
            }

            /* Battle results formatting */
            .battle-results-container {
                page-break-before: always !important;
                padding: 12pt 0 !important;
            }

            .battle-outcome {
                text-align: center !important;
                font-size: 16pt !important;
                font-weight: bold !important;
                margin-bottom: 12pt !important;
                border: 2pt solid black !important;
                padding: 8pt !important;
            }

            .outcome-highlight {
                text-align: center !important;
                font-style: italic !important;
                margin-bottom: 12pt !important;
            }

            /* Map and visual elements */
            .battle-map {
                width: 100% !important;
                max-width: 4in !important;
                height: auto !important;
                margin: 12pt auto !important;
                display: block !important;
                border: 1pt solid black !important;
            }

            /* Side selection for print */
            .sides-container {
                display: block !important;
            }

            .side-card {
                border: 2pt solid black !important;
                margin: 12pt 0 !important;
                padding: 12pt !important;
                page-break-inside: avoid !important;
            }

            .side-name {
                text-align: center !important;
                font-size: 14pt !important;
                font-weight: bold !important;
                margin-bottom: 8pt !important;
            }

            .side-description {
                text-align: justify !important;
                line-height: 1.4 !important;
            }

            /* Victory screen formatting */
            .victory-screen {
                page-break-before: always !important;
                text-align: center !important;
            }

            .victory-title {
                font-size: 20pt !important;
                font-weight: bold !important;
                margin-bottom: 12pt !important;
            }

            .victory-summary {
                text-align: left !important;
                margin: 12pt 0 !important;
            }

            /* Educational content emphasis */
            .vocab-term {
                font-weight: bold !important;
                text-decoration: underline !important;
            }

            /* Page breaks for better organization */
            .battle-content:nth-of-type(odd) {
                page-break-before: always !important;
            }

            /* Footer with educational info */
            .print-footer {
                position: fixed !important;
                bottom: 0.5in !important;
                width: 100% !important;
                text-align: center !important;
                font-size: 10pt !important;
                font-style: italic !important;
                border-top: 1pt solid black !important;
                padding-top: 4pt !important;
            }

            /* Add page numbering */
            @page {
                @bottom-right {
                    content: "Page " counter(page) " of " counter(pages);
                    font-size: 10pt;
                    font-family: Georgia, serif;
                }
            }

            /* Ensure proper text flow */
            p {
                orphans: 3 !important;
                widows: 3 !important;
            }

            /* List formatting */
            ul, ol {
                margin: 8pt 0 !important;
                padding-left: 18pt !important;
            }

            li {
                margin: 2pt 0 !important;
                line-height: 1.3 !important;
            }

            /* Table formatting for battle statistics */
            table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin: 12pt 0 !important;
            }

            th, td {
                border: 1pt solid black !important;
                padding: 4pt !important;
                text-align: left !important;
            }

            th {
                font-weight: bold !important;
                background: #f0f0f0 !important;
            }

            /* Educational worksheet elements */
            .worksheet-space {
                border-bottom: 1pt solid #ccc !important;
                height: 18pt !important;
                margin: 6pt 0 !important;
            }

            .checkbox {
                display: inline-block !important;
                width: 12pt !important;
                height: 12pt !important;
                border: 1pt solid black !important;
                margin-right: 6pt !important;
                vertical-align: middle !important;
            }
        }
        
        /* ===============================================
           BATTLE RESULTS MODAL STYLES
           =============================================== */
        
        .battle-results-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .battle-results-modal.show {
            opacity: 1;
        }
        
        .battle-results-modal .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        
        .battle-results-content {
            position: relative;
            background: linear-gradient(135deg, rgba(20,30,50,0.95), rgba(40,50,70,0.95));
            border: 2px solid var(--color-primary);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .battle-results-modal.show .battle-results-content {
            transform: scale(1);
        }
        
        .results-header {
            margin-bottom: 20px;
        }
        
        .battle-outcome-modal {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }
        
        .battle-outcome-modal.victory {
            color: #4ade80;
        }
        
        .battle-outcome-modal.defeat {
            color: #f87171;
        }
        
        .result-icon-large {
            font-size: 4em;
            margin-bottom: 15px;
        }
        
        .results-body {
            margin-bottom: 25px;
        }
        
        .outcome-summary {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: left;
        }
        
        .score-changes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .score-change-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .score-change-item.positive {
            border-left: 3px solid #4ade80;
        }
        
        .score-change-item.negative {
            border-left: 3px solid #f87171;
        }
        
        .score-change-value {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .score-change-label {
            font-size: 0.9em;
            color: var(--color-text-secondary);
        }
        
        .continue-btn {
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .continue-btn:hover {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .battle-results-content {
                padding: 20px;
                margin: 20px;
            }
            
            .battle-outcome-modal {
                font-size: 2em;
            }
            
            .result-icon-large {
                font-size: 3em;
            }
        }
        
        /* ===============================================
           IMAGE CREDITS STYLES
           =============================================== */
        
        .image-credits-section {
            margin: 30px 0;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .credits-toggle {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: var(--color-text-primary);
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            text-align: left;
        }
        
        .credits-toggle:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-1px);
        }
        
        .credits-toggle:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }
        
        .credits-toggle .credits-icon {
            margin-right: 8px;
        }
        
        .credits-toggle .credits-text {
            flex: 1;
        }
        
        .credits-toggle .credits-arrow {
            transition: transform 0.3s ease;
        }
        
        .credits-toggle[aria-expanded="true"] .credits-arrow {
            transform: rotate(180deg);
        }
        
        .credits-content {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 0;
            margin-top: 10px;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: all 0.4s ease;
        }
        
        .credits-content.expanded {
            max-height: 800px;
            opacity: 1;
            padding: 20px;
        }
        
        .credits-content h3 {
            color: var(--color-primary);
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .credits-content h4 {
            color: var(--color-text-primary);
            margin: 20px 0 10px 0;
            font-size: 1.1em;
        }
        
        .credits-note {
            color: var(--color-text-secondary);
            font-style: italic;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        .credits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .credit-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid var(--color-primary);
        }
        
        .credit-item strong {
            color: var(--color-text-primary);
        }
        
        .credit-item small {
            color: var(--color-text-tertiary);
            font-family: monospace;
        }
        
        .additional-credits {
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 15px;
        }
        
        .additional-credits p {
            margin: 8px 0;
            color: var(--color-text-secondary);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .credits-grid {
                grid-template-columns: 1fr;
            }
            
            .credits-toggle {
                font-size: 0.9rem;
                padding: 10px 15px;
            }
        }
        
        /* Print styles for credits */
        @media print {
            .image-credits-section {
                page-break-before: always;
            }
            
            .credits-toggle {
                display: none;
            }
            
            .credits-content {
                display: block !important;
                max-height: none !important;
                opacity: 1 !important;
                padding: 10pt !important;
                background: white !important;
                border: 1pt solid black;
            }
            
            .credits-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10pt;
            }
            
            .credit-item {
                background: none !important;
                border: 1pt solid #ccc;
                border-left: 3pt solid black;
                page-break-inside: avoid;
            }
        }
        
        /* ===============================================
           PRINT STYLES
           =============================================== */
        
        @media print {
            /* Hide non-essential UI elements */
            .main-navbar,
            .vocab-sidebar,
            .campaign-log-modal,
            .settings-dropdown,
            .image-toggle-group,
            .nav-controls,
            button:not(.print-friendly),
            .choice-option .expand-icon {
                display: none !important;
            }
            
            /* Reset body styles for print */
            body {
                background: white !important;
                color: black !important;
                font-size: 12pt;
                line-height: 1.4;
                margin: 0;
                padding: 20pt;
            }
            
            /* Game containers */
            .game-container {
                box-shadow: none !important;
                border: none !important;
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                max-width: none !important;
            }
            
            /* Battle briefing print layout */
            .battle-briefing {
                display: block !important;
                page-break-inside: avoid;
                margin-bottom: 20pt;
            }
            
            .briefing-header h2 {
                color: black !important;
                font-size: 18pt;
                margin-bottom: 10pt;
                border-bottom: 2pt solid black;
                padding-bottom: 5pt;
            }
            
            .battle-context,
            .strategic-choices {
                background: none !important;
                border: 1pt solid #ccc;
                padding: 10pt;
                margin: 10pt 0;
                border-radius: 0;
            }
            
            .strategic-choices h3 {
                color: black !important;
                font-size: 14pt;
                margin-bottom: 10pt;
            }
            
            .choice-option {
                background: none !important;
                border: 1pt solid #999;
                margin: 5pt 0;
                padding: 8pt;
                page-break-inside: avoid;
            }
            
            .choice-option.expanded .choice-details {
                display: block !important;
            }
            
            /* Side selection cards */
            .side-selection {
                display: block !important;
            }
            
            .side-card {
                background: none !important;
                border: 2pt solid black;
                margin: 10pt 0;
                padding: 10pt;
                page-break-inside: avoid;
            }
            
            .side-card h3 {
                color: black !important;
                font-size: 16pt;
            }
            
            /* Game statistics */
            .game-screen {
                display: block !important;
            }
            
            .stats-container {
                border: 1pt solid black;
                padding: 10pt;
                margin: 10pt 0;
            }
            
            /* Timeline and results */
            .timeline-item {
                border-left: 2pt solid black;
                padding-left: 10pt;
                margin-bottom: 10pt;
                page-break-inside: avoid;
            }
            
            /* Hide images for print to save ink */
            .battle-image,
            .battle-map,
            .side-image {
                display: none !important;
            }
            
            /* Ensure text is readable */
            * {
                color: black !important;
                background: transparent !important;
                text-shadow: none !important;
            }
            
            /* Page breaks */
            .battle-briefing,
            .side-selection,
            .game-screen {
                page-break-before: auto;
                page-break-after: auto;
            }
            
            /* Print-specific typography */
            h1, h2, h3, h4, h5, h6 {
                page-break-after: avoid;
                font-weight: bold;
            }
            
            p, li {
                orphans: 3;
                widows: 3;
            }
            
            /* Show URLs for external links */
            a[href]:after {
                content: " (" attr(href) ")";
                font-size: 0.8em;
                color: #666;
            }
            
            /* Print header */
            body::before {
                content: "Civil War Battle Simulation - Educational Edition";
                display: block;
                text-align: center;
                font-size: 16pt;
                font-weight: bold;
                margin-bottom: 20pt;
                padding-bottom: 10pt;
                border-bottom: 2pt solid black;
            }
        }
        
        /* Version Info Styling */
        .version-info {
            position: fixed;
            bottom: 10px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-family: 'Inter', sans-serif;
            z-index: 1000;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        
        .version-info:hover {
            opacity: 1;
        }
        
        [data-theme="light"] .version-info {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        /* Fix Google Translate bar positioning */
        body {
            top: 0 !important;
            position: static !important;
        }
        
        .goog-te-banner-frame {
            display: none !important;
        }
        
        #google_translate_element {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 999;
            background: rgba(255, 255, 255, 0.95);
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .goog-te-gadget {
            font-size: 0;
        }
        
        .goog-te-gadget .goog-te-combo {
            margin: 0;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 5px;
        }
        
    </style>
</head>
<body onload="initializeTheme()">
    <!-- Skip Navigation Link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Google Translate Element -->
    <div id="google_translate_element"></div>
    
    <!-- Main Navigation Bar -->
    <nav class="main-navbar" role="navigation" aria-label="Main navigation">
        <div class="navbar-content">
            <!-- Left: Game Title -->
            <div class="navbar-brand">
                <h1 class="nav-game-title">‚öîÔ∏è Civil War Simulation</h1>
                <span class="nav-subtitle">Educational Edition</span>
            </div>
            
            <!-- Center: Game Stats (temporarily hidden - will implement leaderboard later) -->
            <!-- <div class="navbar-stats" id="navbarStats" style="display: none;">
                <div class="stat-item">Score: <span id="navScore">0</span></div>
                <div class="stat-item">Soldiers: <span id="navSoldiers">0</span></div>
                <div class="stat-item">Battle <span id="navBattleNumber">1</span>/10</div>
                <div class="stat-item">Wins: <span id="navWins">0</span></div>
            </div> -->
            
            <!-- Right: Controls Menu -->
            <div class="navbar-controls">
                <!-- Primary Actions (always visible) -->
                <button class="nav-btn primary-action" id="campaignLogNavBtn" style="display: none;" aria-label="View campaign log" title="Campaign Log">
                    üìä
                </button>
                
                <!-- Settings Dropdown (cleaner organization) -->
                <div class="settings-dropdown">
                    <button class="nav-btn settings-btn" id="settingsBtn" aria-label="Open menu" aria-expanded="false" title="Menu">
                        ‚ãØ
                    </button>
                    <div class="settings-menu" id="settingsMenu" role="menu" aria-labelledby="settingsBtn">
                        <!-- Learning Tools -->
                        <div class="menu-section">
                            <div class="menu-section-title">Learning Tools</div>
                            <button class="settings-item" id="vocabToggleNav" role="menuitem" aria-label="Toggle vocabulary help">
                                <span class="menu-icon">üìö</span> Vocabulary Help
                                <span class="menu-status" id="vocabStatus">OFF</span>
                            </button>
                        </div>
                        
                        <!-- Appearance -->
                        <div class="settings-divider"></div>
                        <div class="menu-section">
                            <div class="menu-section-title">Appearance</div>
                            <button class="settings-item theme-toggle-item" id="themeToggle" onclick="toggleTheme()" role="menuitem" aria-label="Switch theme">
                                <span class="menu-icon theme-icon">‚òÄÔ∏è</span> <span class="theme-text">Light Theme</span>
                            </button>
                            <div class="settings-item translate-item">
                                <span class="menu-icon">üåê</span>
                                <select class="translate-select-nav" id="translateSelect" onchange="if(this.value) translateWithGoogle(this.value); this.value='';" aria-label="Change language">
                                    <option value="">English</option>
                                    <option value="Spanish">Espa√±ol</option>
                                    <option value="French">Fran√ßais</option>
                                    <option value="Korean">ÌïúÍµ≠Ïñ¥</option>
                                    <option value="Ukrainian">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                                    <option value="Russian">–†—É—Å—Å–∫–∏–π</option>
                                    <option value="Portuguese">Portugu√™s</option>
                                    <option value="Chinese">‰∏≠Êñá</option>
                                    <option value="Japanese">Êó•Êú¨Ë™û</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Game Actions -->
                        <div class="settings-divider" id="gameActionsDiv" style="display: none;"></div>
                        <div class="menu-section" id="gameActionsSection" style="display: none;">
                            <div class="menu-section-title">Game</div>
                            <button class="settings-item danger-item" id="startOverNavBtn" role="menuitem">
                                <span class="menu-icon">üîÑ</span> Start Over
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Vocabulary Overlay for mobile -->
    <div class="vocab-overlay" id="vocabOverlay"></div>
    
    <!-- Vocabulary Sidebar Navigation -->
    <nav class="vocab-sidebar" id="vocabSidebar" role="complementary" aria-label="Vocabulary definitions">
        <h3>üìö Key Terms</h3>
        <ul class="vocab-list">
            <li class="vocab-item">
                <div class="vocab-term-name">Slavery</div>
                <div class="vocab-definition-text">The practice of owning people as property and forcing them to work without pay</div>
            </li>
            <li class="vocab-item">
                <div class="vocab-term-name">States' Rights</div>
                <div class="vocab-definition-text">The belief that each state should decide its own laws instead of the federal government</div>
            </li>
            <li class="vocab-item">
                <div class="vocab-term-name">Civil War</div>
                <div class="vocab-definition-text">A war fought between people from the same country</div>
            </li>
            <li class="vocab-item">
                <div class="vocab-term-name">Reinforcements</div>
                <div class="vocab-definition-text">Extra soldiers sent to help your army when you need them</div>
            </li>
            <li class="vocab-item">
                <div class="vocab-term-name">Flanking</div>
                <div class="vocab-definition-text">A military tactic of attacking the sides of an enemy formation</div>
            </li>
            <li class="vocab-item">
                <div class="vocab-term-name">Fortification</div>
                <div class="vocab-definition-text">Structures built to defend against attack</div>
            </li>
            <li class="vocab-item">
                <div class="vocab-term-name">Retreat</div>
                <div class="vocab-definition-text">Moving forces away from battle to a safer position</div>
            </li>
            <li class="vocab-item">
                <div class="vocab-term-name">Casualties</div>
                <div class="vocab-definition-text">Soldiers killed, wounded, or missing in battle</div>
            </li>
        </ul>
    </nav>
    
    <!-- Vocabulary Toggle Button -->

    <main class="game-container" id="main-content" role="main" aria-label="Civil War Battle Simulation Game">
        <!-- Side Selection Screen -->
        <div class="side-selection" id="sideSelection" role="region" aria-label="Choose your side">
            <h2 class="section-title">Choose Your Side</h2>
            <p class="subtitle">Command either the Union or Confederacy through 10 historic battles</p>
            
            <!-- Civil War Introduction - only shown on first visit -->
            <div class="civil-war-intro" id="civilWarIntro" style="display: none;">
                <h2 style="color: #ffd700; text-align: center; margin-bottom: 20px;">‚öîÔ∏è The American Civil War (1861-1865) ‚öîÔ∏è</h2>
                
                <div class="intro-content">
                    <p style="font-size: 1.1em; line-height: 1.6; margin-bottom: 20px; text-align: center;">
                        From 1861 to 1865, Americans fought Americans in our nation's deadliest conflict. 
                        Over 600,000 people died fighting about <strong style="color: #ffd700;">slavery</strong> and whether states could leave the Union.
                    </p>
                    
                    <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center;">
                        <p style="font-size: 1em; line-height: 1.5; margin: 0;">
                            <strong>üéØ Your Mission:</strong> Command one side through 10 major battles, making the same tough decisions real generals faced!
                        </p>
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <button onclick="hideIntroduction()" style="background: linear-gradient(135deg, #059669, #10b981); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-family: 'Georgia', serif; font-size: 1em;">
                            Continue to Side Selection ‚Üí
                        </button>
                    </div>
                </div>
            </div>
            
            
            <div class="sides-container">
                <div class="side-card union-card" id="unionCard" role="button" tabindex="0" aria-labelledby="union-name" aria-describedby="union-description">
                    <span class="side-flag" aria-hidden="true">üá∫üá∏</span>
                    <h2 class="side-name" id="union-name">Union (The North)</h2>
                    <div id="union-description">
                        <p class="side-description">
                            <strong>üè≠ Industrial Powerhouse</strong><br>
                            You command President Lincoln's forces fighting to keep America united and end <strong style="color: #ffd700;">slavery</strong> forever. 
                            Use your factories, railroads, and larger population to crush the rebellion!
                        </p>
                        <div style="background: rgba(59, 130, 246, 0.2); padding: 10px; border-radius: 8px; margin: 10px 0;">
                            <p style="font-size: 0.9em; margin: 0;"><strong>Your Advantages:</strong> More <strong style="color: #ffd700;">reinforcements</strong>, better weapons, naval blockade</p>
                        </div>
                        <p class="soldier-count">Starting Army: 1,500,000 soldiers</p>
                        <p class="victory-condition">
                            üéØ Win 6 out of 10 battles to save the Union!
                        </p>
                    </div>
                    <button class="select-strategy-btn sr-only focusable">Select Union Army</button>
                </div>
                
                <div class="side-card confederacy-card" id="confederacyCard" role="button" tabindex="0" aria-labelledby="confederacy-name" aria-describedby="confederacy-description">
                    <span class="side-flag" aria-hidden="true">üè¥</span>
                    <h2 class="side-name" id="confederacy-name">Confederacy (The South)</h2>
                    <div id="confederacy-description">
                        <p class="side-description">
                            <strong>‚öîÔ∏è Defending the South</strong><br>
                            Fight for Southern independence and defend your homeland! The Confederacy seceded because they wanted to preserve <strong style="color: #ffd700;">slavery</strong> and their way of life. 
                            You're outnumbered, but you have skilled generals and fight on familiar ground.
                        </p>
                        <div style="background: rgba(107, 114, 128, 0.2); padding: 10px; border-radius: 8px; margin: 10px 0;">
                            <p style="font-size: 0.9em; margin: 0;"><strong>Your Advantages:</strong> Experienced generals like Lee, fighting on home territory, strong defensive positions</p>
                        </div>
                        <p class="soldier-count">Starting Army: 1,000,000 soldiers</p>
                        <p class="victory-condition">
                            üéØ Win 5 out of 10 battles to gain independence!
                        </p>
                    </div>
                    <button class="select-strategy-btn sr-only focusable">Select Confederate Army</button>
                </div>
            </div>
        </div>
        
        <!-- Side Introduction Screen -->
        <div class="side-introduction" id="sideIntroduction" role="region" aria-label="Side introduction and objectives">
            <div class="leader-message">
                <div class="leader-portrait" id="leaderPortrait">üé©</div>
                <h2 class="leader-name" id="leaderName">President Abraham Lincoln</h2>
                <div class="message-text" id="leaderMessage">
                    <!-- Message will be inserted here -->
                </div>
            </div>
            
            <div class="war-objectives">
                <h3 class="objectives-title">Your Mission</h3>
                <div id="objectivesList">
                    <!-- Objectives will be inserted here -->
                </div>
            </div>
            
            <button class="proceed-btn" id="proceedToGame">Begin Your Command</button>
            <button class="back-btn" id="backToSideBtn">‚Üê Choose Different Side</button>
        </div>
        
        <!-- Battle Briefing Screen -->
        <div class="battle-briefing" id="battleBriefing" role="region" aria-label="Battle briefing and strategy selection">
            <div class="briefing-header">
                <h2 class="briefing-title" id="briefingTitle">First Battle of Bull Run</h2>
                <p class="briefing-date" id="briefingDate">July 21, 1861</p>
            </div>
            
            <div class="battle-context">
                <h3 class="context-title">Historical Context</h3>
                <div class="context-text" id="contextText">
                    <!-- Battle context will be inserted here -->
                </div>
                
                <div class="battle-visual-container">
                    <div class="visual-toggle-controls">
                        <button class="visual-toggle-btn active" id="photoToggle" data-view="photo">
                            üì∑ Historical Image
                        </button>
                        <button class="visual-toggle-btn" id="mapToggle" data-view="map">
                            üó∫Ô∏è Battle Map
                        </button>
                    </div>
                    
                    <div class="battle-image" id="briefingImage">
                        <!-- Battle image will be inserted here -->
                    </div>
                    
                    <div class="battle-map" id="briefingMap" style="display: none;">
                        <!-- SVG mini-map will be inserted here -->
                    </div>
                </div>
            </div>
            
            <div class="strategic-choices" role="group" aria-labelledby="choices-title">
                <h3 class="choices-title" id="choices-title">Choose Your Strategy</h3>
                <p style="margin-bottom: 15px; color: #ccc; text-align: center; font-size: 1em;">
                    üí° <strong>How to play:</strong> Click any strategy below to see its pros and cons, then click again to lock in your choice!
                </p>
                
                <div id="choicesList" role="radiogroup" aria-labelledby="choices-title">
                    <!-- Strategy choices will be inserted here -->
                </div>
            </div>
        </div>
        
        <!-- Game Screen (Battle Results) -->
        <div class="game-screen" id="gameScreen" role="region" aria-label="Game dashboard and statistics">
            <div class="battle-results-container">
                <h2 class="battle-outcome" id="battleOutcome"></h2>
                
                <!-- Quick Results Summary -->
                <div class="results-summary">
                    <div class="result-card">
                        <div class="result-icon" id="resultIcon">üèÜ</div>
                        <div class="result-text" id="resultText">Your strategy succeeded!</div>
                    </div>
                    
                    <div class="impact-stats">
                        <div class="impact-item">
                            <span class="impact-label">Casualties:</span>
                            <span class="impact-value casualties" id="casualtiesSummary">25,000 lost</span>
                        </div>
                        <div class="impact-item">
                            <span class="impact-label">Score:</span>
                            <span class="impact-value points" id="scoreSummary">+400 points</span>
                        </div>
                        <div class="impact-item">
                            <span class="impact-label">Army Size:</span>
                            <span class="impact-value soldiers" id="armySummary">975,000 remain</span>
                        </div>
                    </div>
                </div>
                
                <div class="battle-explanation">
                    <h3 class="explanation-title">What Happened?</h3>
                    <div class="explanation-text" id="explanationText">
                        <!-- Battle explanation will be inserted here -->
                    </div>
                    
                    <div class="historical-note">
                        <div class="historical-note-title">üìö Historical Note</div>
                        <div id="historicalNote">
                            <!-- Historical information will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <button class="continue-battle-btn" id="continueBattleBtn">Continue to Next Battle</button>
            </div>
        </div>

        <!-- Battle Results Modal -->
        <div class="battle-results-modal" id="battleResultsModal" style="display: none;">
            <div class="modal-overlay"></div>
            <div class="battle-results-content">
                <div class="results-header">
                    <h2 class="battle-outcome-modal" id="battleOutcomeModal"></h2>
                    <div class="result-icon-large" id="resultIconModal">üèÜ</div>
                </div>
                
                <div class="results-body">
                    <div class="outcome-summary" id="outcomeSummaryModal">
                        <!-- Summary will be inserted here -->
                    </div>
                    
                    <div class="score-changes" id="scoreChangesModal">
                        <!-- Score changes will be inserted here -->
                    </div>
                </div>
                
                <div class="results-actions">
                    <button class="continue-btn primary-btn" id="continueFromResultsBtn">Continue Campaign</button>
                </div>
            </div>
        </div>

        <!-- Campaign Log Modal -->
        <div class="campaign-log-modal" id="campaignLogModal">
            <div class="campaign-log-container">
                <div class="log-header">
                    <h2 class="log-title">Your Campaign Progress</h2>
                    <button class="close-log-btn" id="closeLogBtn">&times;</button>
                </div>
                
                <div class="campaign-overview">
                    <div class="progress-summary">
                        <div class="summary-stat">
                            <div class="stat-number" id="battlesCompleted">3</div>
                            <div class="stat-label">Battles Fought</div>
                        </div>
                        <div class="summary-stat">
                            <div class="stat-number" id="winsCount">2</div>
                            <div class="stat-label">Victories</div>
                        </div>
                        <div class="summary-stat">
                            <div class="stat-number" id="currentScore">1,250</div>
                            <div class="stat-label">Total Score</div>
                        </div>
                    </div>
                    
                    <div class="victory-progress">
                        <h3 class="progress-title">Progress to Victory</h3>
                        <div class="victory-bar">
                            <div class="victory-fill" id="victoryFill" style="width: 33%"></div>
                            <div class="victory-text" id="victoryText">2 of 6 wins needed</div>
                        </div>
                    </div>
                </div>
                
                <div class="battle-timeline">
                    <h3 class="timeline-title">Battle Timeline</h3>
                    <div class="timeline-container" id="timelineContainer">
                        <!-- Timeline items will be inserted here -->
                    </div>
                </div>
                
                <div class="strategy-analysis">
                    <h3 class="analysis-title">Your Decision-Making</h3>
                    <div class="strategy-stats" id="strategyStats">
                        <!-- Strategy analysis will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- End Game Summary -->
        <div class="end-game-summary" id="endGameSummary">
            <div class="outcome-banner" id="outcomeBanner">
                <h1 class="outcome-title" id="outcomeTitle"></h1>
                <p class="outcome-subtitle" id="outcomeSubtitle">The Union is Preserved</p>
            </div>
            
            <div class="final-stats-container">
                <h2 style="color: #ffd700; margin-bottom: 20px;">Campaign Summary</h2>
                <div id="finalStatsText">
                    <!-- Final statistics will be inserted here -->
                </div>
            </div>
            
            <!-- Image Credits Section -->
            <div class="image-credits-section">
                <button class="credits-toggle" id="creditsToggle" 
                        aria-expanded="false" 
                        aria-controls="creditsContent"
                        type="button">
                    <span class="credits-icon">üì∑</span>
                    <span class="credits-text">View Image Credits</span>
                    <span class="credits-arrow">‚ñº</span>
                </button>
                
                <div class="credits-content" id="creditsContent" aria-hidden="true">
                    <h3>Image Credits & Sources</h3>
                    <p class="credits-note">All images used in this educational simulation are in the public domain or used under fair use provisions for educational purposes.</p>
                    
                    <div class="credits-grid">
                        <div class="credit-item">
                            <strong>Battle of Bull Run:</strong><br>
                            Library of Congress, Public Domain<br>
                            <small>LC-DIG-pga-01884</small>
                        </div>
                        
                        <div class="credit-item">
                            <strong>Battle of Antietam:</strong><br>
                            National Archives, Public Domain<br>
                            <small>165-SB-23</small>
                        </div>
                        
                        <div class="credit-item">
                            <strong>Battle of Gettysburg:</strong><br>
                            Library of Congress, Public Domain<br>
                            <small>LC-DIG-cwpb-03360</small>
                        </div>
                        
                        <div class="credit-item">
                            <strong>Battle of Fredericksburg:</strong><br>
                            National Park Service, Public Domain<br>
                            <small>Historical Collection</small>
                        </div>
                        
                        <div class="credit-item">
                            <strong>Battle of Chancellorsville:</strong><br>
                            Library of Congress, Public Domain<br>
                            <small>LC-DIG-pga-02502</small>
                        </div>
                        
                        <div class="credit-item">
                            <strong>Battle of Vicksburg:</strong><br>
                            National Archives, Public Domain<br>
                            <small>111-B-158</small>
                        </div>
                        
                        <div class="credit-item">
                            <strong>Battle of Chickamauga:</strong><br>
                            Library of Congress, Public Domain<br>
                            <small>LC-DIG-pga-02891</small>
                        </div>
                        
                        <div class="credit-item">
                            <strong>Battle of the Wilderness:</strong><br>
                            National Park Service, Public Domain<br>
                            <small>Historical Archive</small>
                        </div>
                        
                        <div class="credit-item">
                            <strong>Battle of Spotsylvania:</strong><br>
                            Library of Congress, Public Domain<br>
                            <small>LC-DIG-cwpb-02891</small>
                        </div>
                        
                        <div class="credit-item">
                            <strong>Surrender at Appomattox:</strong><br>
                            National Archives, Public Domain<br>
                            <small>111-B-4910</small>
                        </div>
                    </div>
                    
                    <div class="additional-credits">
                        <h4>Additional Resources</h4>
                        <p><strong>Battle Maps:</strong> Created for educational use based on historical sources</p>
                        <p><strong>Icons & UI Elements:</strong> Custom designed for this simulation</p>
                        <p><strong>Historical Context:</strong> Based on official military records and historical documentation</p>
                    </div>
                </div>
            </div>
            
            <button class="play-again-btn" id="playAgainBtn">Play Again</button>
        </div>
    </main>

<script>
    // Game State
    let gameState = {
        side: null,
        currentBattle: 0,
        score: 0,
        soldiers: 0,
        wins: 0,
        losses: 0,
        battleHistory: []
    };

    // Settings
    let settings = {
        vocabHelp: true
    };

    // Complete battle data with all 10 battles
    const battles = [
        {
            name: "First Battle of Bull Run",
            date: "July 21, 1861",
            imageUrl: "images/battle_of_bull_run.jpg",
            imageCredit: "Kurz & Allison, 1889",
            context: "üé™ <strong>The Battle That Shocked America!</strong><br><br>This was the first major battle of the Civil War, and nobody knew what to expect. Both armies were mostly volunteers who had never seen real combat. Incredibly, hundreds of people from Washington D.C. packed picnic baskets and came out to watch like it was a sporting event!<br><br>The battle took place near a small creek called Bull Run in Virginia, just 30 miles from the nation's capital. Everyone thought one big fight would end the war quickly. They were very, very wrong. The reality of war hit hard when inexperienced soldiers on both sides panicked and ran. This wake-up call showed Americans that the Civil War would be long, bloody, and devastating.",
            strategies: [
                {
                    name: "Direct Attack",
                    description: "Order your troops to march straight at the enemy and attack their main force",
                    explanation: "This is the most straightforward approach - no fancy moves, just advance and fight. It can work if you have more soldiers or better equipment.",
                    pros: ["Simple to understand and execute", "Can overwhelm a weaker enemy", "Shows courage and determination"],
                    cons: ["Enemy can see you coming", "You might take heavy casualties", "No element of surprise"],
                    union: { win: false, soldierLoss: 2900, scoreGain: 100 },
                    confederacy: { win: true, soldierLoss: 2000, scoreGain: 400 }
                },
                {
                    name: "Defensive Position",
                    description: "Have your army dig in and wait for the enemy to attack you",
                    explanation: "Defense means letting the enemy come to you while you're in a strong position. Soldiers behind <span class='vocab-term'>fortifications<span class='vocab-tooltip'><div class='vocab-definition'>Structures built to defend against attack</div></span></span> are much harder to defeat.",
                    pros: ["Harder for enemy to hurt you", "You can choose the best ground", "Saves energy and supplies"],
                    cons: ["You give up the initiative", "Enemy might go around you", "Doesn't win territory"],
                    union: { win: false, soldierLoss: 2500, scoreGain: 200 },
                    confederacy: { win: true, soldierLoss: 1500, scoreGain: 300 }
                },
                {
                    name: "Flanking Movement",
                    description: "Try to march around the enemy's side and attack them from an unexpected direction",
                    explanation: "A <span class='vocab-term'>flanking<span class='vocab-tooltip'><div class='vocab-definition'>A military tactic of attacking the sides of an enemy formation</div></span></span> attack can surprise the enemy and force them to fight in two directions at once. It's risky because it splits your forces.",
                    pros: ["Element of surprise", "Can confuse the enemy", "Might cause enemy to retreat quickly"],
                    cons: ["Complex to coordinate", "Takes more time", "If it fails, you're in trouble"],
                    union: { win: false, soldierLoss: 2700, scoreGain: 150 },
                    confederacy: { win: true, soldierLoss: 1900, scoreGain: 350 }
                }
            ],
            results: {
                union_loss: "The Union army was defeated in their first major battle. Many soldiers panicked and ran back toward Washington D.C., mixing with the civilians who had come to watch. This showed both sides that the war would not be over quickly.",
                confederacy_victory: "The Confederate forces successfully defended Virginia and gained confidence that they could defeat the larger Union army. However, they were too disorganized to pursue the retreating Union forces back to Washington."
            },
            historical_notes: {
                general: "This battle convinced both North and South that the war would last longer than expected. It led to both sides recruiting larger, better-trained armies."
            }
        },
        {
            name: "Battle of Shiloh",
            date: "April 6-7, 1862",
            imageUrl: "images/battle_of_shiloh.jpg",
            imageCredit: "Thure de Thulstrup, 1888",
            context: "General Ulysses S. Grant's Union army was camping near Shiloh Church in Tennessee when Confederate forces launched a surprise dawn attack. The Confederates hoped to destroy Grant's army before <span class='vocab-term'>reinforcements<span class='vocab-tooltip'><div class='vocab-definition'>Additional troops sent to strengthen a military force</div></span></span> could arrive. This was one of the bloodiest battles so far in the war.",
            strategies: [
                {
                    name: "Immediate Counterattack",
                    description: "Rally your surprised troops and attack back as quickly as possible",
                    explanation: "When you're surprised, sometimes the best defense is a quick offense. This can stop the enemy's momentum and show your soldiers you're still in control.",
                    pros: ["Stops enemy momentum", "Shows leadership", "Can turn surprise into opportunity"],
                    cons: ["Troops might be confused", "Haven't had time to plan", "Could lead to heavy losses"],
                    union: { win: true, soldierLoss: 40000, scoreGain: 400 },
                    confederacy: { win: false, soldierLoss: 55000, scoreGain: 150 }
                },
                {
                    name: "Form Defensive Lines",
                    description: "Organize your scattered forces into strong defensive positions",
                    explanation: "Getting organized and forming a solid line can stop a surprise attack. This gives you time to figure out what's happening and plan your next move.",
                    pros: ["Stops the panic", "Creates organized resistance", "Gives time to think"],
                    cons: ["Takes time you might not have", "Gives enemy more initiative", "Might seem like retreating"],
                    union: { win: true, soldierLoss: 35000, scoreGain: 350 },
                    confederacy: { win: false, soldierLoss: 45000, scoreGain: 200 }
                },
                {
                    name: "Strategic Retreat",
                    description: "Pull back to a better position and regroup your forces",
                    explanation: "Sometimes <span class='vocab-term'>retreating<span class='vocab-tooltip'><div class='vocab-definition'>Moving forces away from battle to a safer position</div></span></span> to better ground is the smart choice. It can save lives and let you fight on your terms.",
                    pros: ["Saves soldier's lives", "Gets you to better ground", "Gives time to plan"],
                    cons: ["Looks like giving up", "Enemy gains territory", "Hard to stop once started"],
                    union: { win: false, soldierLoss: 30000, scoreGain: 150 },
                    confederacy: { win: true, soldierLoss: 25000, scoreGain: 400 }
                }
            ],
            results: {
                union_victory: "Despite being surprised, Union forces managed to hold their ground and eventually push back the Confederate attack when reinforcements arrived the next day.",
                confederacy_defeat: "The Confederate surprise attack initially succeeded, but they couldn't finish off Grant's army before Union reinforcements arrived, turning victory into defeat."
            },
            historical_notes: {
                general: "This battle showed the importance of communication and coordination. It also demonstrated that the war was becoming more deadly - over 23,000 total casualties shocked both sides."
            }
        },
        {
            name: "Battle of Antietam",
            date: "September 17, 1862",
            imageUrl: "images/battle_of_antietam.jpg",
            imageCredit: "Kurz & Allison, 1888",
            context: "Robert E. Lee's Confederate army invaded Maryland, hoping to bring the war to Union territory and maybe convince European countries to help the South. But Union forces found Lee's battle plans wrapped around some cigars! Now General McClellan knows exactly where Lee's forces are positioned. This could be the chance to end the rebellion.",
            strategies: [
                {
                    name: "Coordinated Assault",
                    description: "Use your knowledge of enemy positions to attack multiple points at once",
                    explanation: "Since you know where the enemy is, you can hit them everywhere at the same time. This prevents them from moving troops to help each other.",
                    pros: ["Enemy can't reinforce weak spots", "Uses your intelligence advantage", "Could end the war quickly"],
                    cons: ["Complex coordination required", "If one attack fails, all might fail", "Spreads your forces thin"],
                    union: { win: true, soldierLoss: 50000, scoreGain: 500 },
                    confederacy: { win: false, soldierLoss: 45000, scoreGain: 150 }
                },
                {
                    name: "Cautious Advance",
                    description: "Move slowly and carefully, making sure each position is secure",
                    explanation: "Even with enemy plans, battles are dangerous. Moving carefully ensures you don't fall into any traps and can retreat if needed.",
                    pros: ["Reduces risk of disaster", "Keeps army intact", "Maintains steady pressure"],
                    cons: ["Gives enemy time to react", "Might miss opportunities", "Could drag out the battle"],
                    union: { win: true, soldierLoss: 35000, scoreGain: 300 },
                    confederacy: { win: false, soldierLoss: 35000, scoreGain: 200 }
                },
                {
                    name: "Focus on Escape Routes",
                    description: "Try to cut off the Confederate army's retreat back to Virginia",
                    explanation: "Instead of just winning the battle, try to trap Lee's entire army. This could capture thousands of Confederate soldiers and end the war.",
                    pros: ["Could capture entire enemy army", "Would end the war quickly", "Prevents enemy from escaping"],
                    cons: ["Very difficult to execute", "Enemy might fight harder when trapped", "Risky if it fails"],
                    union: { win: true, soldierLoss: 60000, scoreGain: 600 },
                    confederacy: { win: false, soldierLoss: 55000, scoreGain: 100 }
                }
            ],
            results: {
                union_victory: "The Union army successfully used their intelligence advantage to defeat Lee's invasion. The Confederate army was forced to retreat back to Virginia.",
                confederacy_defeat: "Despite fighting bravely, the Confederate army was outmaneuvered and forced to abandon their invasion of the North."
            },
            historical_notes: {
                general: "This was the bloodiest single day in American military history, with over 22,000 casualties. The Union victory convinced European countries not to recognize the Confederacy."
            }
        },
        {
            name: "Battle of Gettysburg",
            date: "July 1-3, 1863",
            imageUrl: "images/battle_of_gettysburg.jpg",
            imageCredit: "Thure de Thulstrup, 1887",
            context: "This three-day battle in Pennsylvania is often called the turning point of the Civil War. Robert E. Lee's Confederate army had invaded the North, hoping a victory on Union soil would convince other countries to help the Confederacy and maybe end the war. The battle started by accident when Confederate soldiers looking for shoes encountered Union cavalry in the town of Gettysburg.",
            strategies: [
                {
                    name: "Hold the High Ground",
                    description: "Keep your forces on the hills and ridges around Gettysburg",
                    explanation: "High ground gives you huge advantages in battle - you can see farther, your cannons shoot farther, and it's harder for enemies to attack uphill. Cemetery Ridge and Little Round Top were key positions.",
                    pros: ["Artillery advantage", "Better visibility", "Harder to attack uphill"],
                    cons: ["Enemy might go around you", "Limited to defensive actions", "Harder to get supplies uphill"],
                    union: { win: true, soldierLoss: 35000, scoreGain: 600 },
                    confederacy: { win: false, soldierLoss: 50000, scoreGain: 150 }
                },
                {
                    name: "Attack the Center",
                    description: "Launch a massive assault on the enemy's main battle line",
                    explanation: "Sometimes a bold attack right at the enemy's strongest point can work - if you break through the center, you split their army in half. This is what 'Pickett's Charge' attempted to do.",
                    pros: ["If successful, splits enemy army", "Shows maximum courage", "Quick decision"],
                    cons: ["Attacking uphill is very difficult", "Heavy casualties expected", "Enemy can concentrate fire"],
                    union: { win: true, soldierLoss: 40000, scoreGain: 500 },
                    confederacy: { win: false, soldierLoss: 60000, scoreGain: 100 }
                },
                {
                    name: "Flanking Maneuver",
                    description: "Try to attack around the enemy's sides or behind them",
                    explanation: "Instead of attacking where the enemy expects, try to get around to their flanks or rear. This worked well for Lee in earlier battles, but the terrain at Gettysburg made it harder.",
                    pros: ["Avoids strongest defenses", "Can cause panic", "Element of surprise"],
                    cons: ["Takes time and coordination", "Terrain might not allow it", "Leaves your own flanks exposed"],
                    union: { win: true, soldierLoss: 30000, scoreGain: 550 },
                    confederacy: { win: false, soldierLoss: 45000, scoreGain: 200 }
                }
            ],
            results: {
                union_victory: "The Union army successfully defended their positions over three days. The famous 'Pickett's Charge' on the final day was repulsed with heavy Confederate losses, forcing Lee to retreat back to Virginia.",
                confederacy_defeat: "Lee's invasion of the North failed. The Confederate army suffered over 25,000 casualties and was forced to retreat. This marked the beginning of the end for Confederate hopes of victory."
            },
            historical_notes: {
                general: "Gettysburg is often called the turning point of the Civil War. After this defeat, the Confederacy would mostly fight defensive battles. President Lincoln later gave his famous Gettysburg Address at the dedication of the battlefield cemetery."
            }
        },
        {
            name: "Battle of Fredericksburg",
            date: "December 13, 1862",
            imageUrl: "images/battle_of_fredericksburg.jpg",
            imageCredit: "Kurz & Allison, 1888",
            context: "General Burnside's Union army must cross the Rappahannock River and attack Confederate positions on Marye's Heights. Lee has had weeks to prepare his defenses, including a stone wall that creates a perfect <span class='vocab-term'>fortification<span class='vocab-tooltip'><div class='vocab-definition'>A structure built to defend against attack</div></span></span>. The Confederates have the high ground and are well-prepared.",
            strategies: [
                {
                    name: "Direct Assault",
                    description: "Attack the Confederate positions on Marye's Heights head-on",
                    explanation: "Sometimes courage and determination can overcome defensive advantages. A direct attack shows your soldiers you're committed to victory.",
                    pros: ["Shows determination", "Simple to execute", "Could overwhelm defenses"],
                    cons: ["Attacking uphill against fortifications", "Enemy has had time to prepare", "Likely to cause heavy casualties"],
                    union: { win: false, soldierLoss: 70000, scoreGain: 50 },
                    confederacy: { win: true, soldierLoss: 10000, scoreGain: 500 }
                },
                {
                    name: "Artillery Bombardment First",
                    description: "Use your cannons to soften enemy defenses before attacking",
                    explanation: "Cannon fire can damage enemy fortifications and force defenders to keep their heads down. This might make an assault more successful.",
                    pros: ["Weakens enemy defenses", "Provides cover for advancing troops", "Uses your artillery advantage"],
                    cons: ["Gives enemy warning", "Might not be effective against stone walls", "Uses up ammunition"],
                    union: { win: false, soldierLoss: 55000, scoreGain: 100 },
                    confederacy: { win: true, soldierLoss: 15000, scoreGain: 400 }
                },
                {
                    name: "Find Alternative Crossing",
                    description: "Look for another way to cross the river and avoid the prepared defenses",
                    explanation: "Instead of attacking where the enemy expects, try to find a different route. This takes time but might avoid the strongest defenses.",
                    pros: ["Avoids strongest enemy positions", "Element of surprise", "Could get behind enemy lines"],
                    cons: ["Takes more time", "Other crossings might be defended too", "Difficult in winter weather"],
                    union: { win: false, soldierLoss: 40000, scoreGain: 200 },
                    confederacy: { win: true, soldierLoss: 20000, scoreGain: 350 }
                }
            ],
            results: {
                union_loss: "The Union attacks failed with terrible losses. Wave after wave of brave soldiers fell before the Confederate defenses. Burnside was soon replaced as commander.",
                confederacy_victory: "Confederate forces held their strong defensive positions and inflicted heavy casualties on the attacking Union forces. The stone wall at Marye's Heights proved nearly impregnable."
            },
            historical_notes: {
                general: "This battle showed the deadly effectiveness of defensive positions in the Civil War. The improved weapons of the 1860s made frontal assaults extremely costly."
            }
        },
        {
            name: "Battle of Chancellorsville",
            date: "May 2-4, 1863",
            imageUrl: "images/battle_of_chancellorsville.jpg",
            imageCredit: "Kurz & Allison, 1888",
            context: "General Hooker's large Union army faces Lee in the tangled wilderness of Virginia. Despite being outnumbered 2-to-1, Lee plans his most daring move yet: splitting his already smaller army to send Stonewall Jackson on a <span class='vocab-term'>flanking<span class='vocab-tooltip'><div class='vocab-definition'>An attack on the side of an enemy formation</div></span></span> march around the Union right flank. It's incredibly risky, but it might be the only way to win.",
            strategies: [
                {
                    name: "Hold Defensive Positions",
                    description: "Stay in your strong positions and let the enemy come to you",
                    explanation: "You have more soldiers and good defensive positions. Let Lee make the risky moves while you stay safe and strong.",
                    pros: ["Uses your numerical advantage", "Reduces risk", "Forces enemy to attack you"],
                    cons: ["Gives up initiative", "Enemy might outmaneuver you", "Doesn't press your advantages"],
                    union: { win: false, soldierLoss: 45000, scoreGain: 200 },
                    confederacy: { win: true, soldierLoss: 30000, scoreGain: 450 }
                },
                {
                    name: "Attack While Enemy is Divided",
                    description: "Strike hard while Lee's army is split in two",
                    explanation: "Lee has taken a huge risk by dividing his smaller army. If you attack quickly, you might destroy part of his force before they can reunite.",
                    pros: ["Enemy is vulnerable while divided", "Could destroy part of enemy army", "Takes advantage of enemy's risk"],
                    cons: ["Difficult to coordinate in the wilderness", "Might fall into a trap", "Could be caught by Jackson's flanking force"],
                    union: { win: true, soldierLoss: 40000, scoreGain: 500 },
                    confederacy: { win: false, soldierLoss: 35000, scoreGain: 150 }
                },
                {
                    name: "Withdraw to Open Ground",
                    description: "Pull back out of the wilderness to fight in more open terrain",
                    explanation: "The dense forest helps Lee's smaller army hide their movements. In open ground, your larger army would have more advantages.",
                    pros: ["Better terrain for larger army", "Easier to coordinate", "Reduces Lee's advantages"],
                    cons: ["Looks like retreating", "Gives up current positions", "Might encourage enemy"],
                    union: { win: false, soldierLoss: 35000, scoreGain: 250 },
                    confederacy: { win: true, soldierLoss: 25000, scoreGain: 400 }
                }
            ],
            results: {
                union_loss: "Jackson's surprise flank attack succeeded brilliantly, routing part of the Union army. However, Jackson was accidentally shot by his own men and died, a huge loss for the Confederacy.",
                confederacy_victory: "Lee and Jackson's bold plan worked perfectly, defeating a much larger enemy force. But the victory came at a terrible cost when Jackson was mortally wounded by friendly fire."
            },
            historical_notes: {
                general: "This battle is considered Lee's masterpiece of tactical brilliance. However, the death of Stonewall Jackson was a blow from which the Confederate army never recovered."
            }
        },
        {
            name: "Battle of Chickamauga",
            date: "September 19-20, 1863",
            imageUrl: "images/battle_of_chickamauga.jpg",
            imageCredit: "Kurz & Allison, 1890",
            context: "In the forests of northern Georgia, Confederate General Bragg's army has caught Union General Rosecrans' forces spread out and vulnerable. The thick woods make it hard to see what's happening, and both sides are confused. A mistake in Union orders has created a gap in their battle line - but will the Confederates be able to exploit it?",
            strategies: [
                {
                    name: "Exploit the Gap",
                    description: "Pour troops through the opening in the enemy line",
                    explanation: "A gap in the enemy line is like an open door - if you can get troops through it quickly, you can attack the enemy from behind and cause panic.",
                    pros: ["Could cause enemy collapse", "Attacks enemy from behind", "Creates confusion in enemy ranks"],
                    cons: ["Gap might be a trap", "Could get isolated", "Difficult to coordinate in thick forest"],
                    union: { win: false, soldierLoss: 55000, scoreGain: 100 },
                    confederacy: { win: true, soldierLoss: 35000, scoreGain: 500 }
                },
                {
                    name: "Steady Pressure",
                    description: "Attack all along the enemy line with coordinated pressure",
                    explanation: "Instead of gambling everything on one attack, apply pressure everywhere. This is safer and might find other weak points.",
                    pros: ["Reduces risk", "Tests entire enemy line", "Harder for enemy to concentrate defense"],
                    cons: ["Doesn't exploit specific advantages", "Might not achieve breakthrough", "Could lead to stalemate"],
                    union: { win: false, soldierLoss: 40000, scoreGain: 200 },
                    confederacy: { win: true, soldierLoss: 30000, scoreGain: 400 }
                },
                {
                    name: "Defensive Stand",
                    description: "Form strong defensive positions and let the enemy attack you",
                    explanation: "The confusion in the forest affects both sides. Sometimes the best move is to get organized and make the enemy come to you.",
                    pros: ["Reduces confusion", "Uses defensive advantages", "Conserves strength"],
                    cons: ["Gives up initiative", "Might miss opportunities", "Could allow enemy to escape"],
                    union: { win: false, soldierLoss: 35000, scoreGain: 250 },
                    confederacy: { win: true, soldierLoss: 25000, scoreGain: 350 }
                }
            ],
            results: {
                union_loss: "The Confederate breakthrough shattered part of the Union army, forcing them to retreat toward Chattanooga. Only General Thomas's heroic stand prevented complete disaster.",
                confederacy_victory: "Longstreet's corps smashed through the gap in Union lines, achieving one of the Confederacy's greatest tactical victories. However, they couldn't pursue effectively due to the difficult terrain."
            },
            historical_notes: {
                general: "This was one of the Confederacy's last major victories, but they failed to destroy the Union army completely. The Union retreat to Chattanooga led to a siege that would eventually favor the North."
            }
        },
        {
            name: "Battle of the Wilderness",
            date: "May 5-6, 1864",
            imageUrl: "images/battle_of_the_wilderness.jpg",
            imageCredit: "Kurz & Allison",
            context: "General Grant begins his campaign to end the war by fighting Lee continuously. The battle takes place in the same tangled Virginia wilderness where Hooker was defeated a year earlier. The thick undergrowth makes it almost impossible to see, and forest fires threaten to burn wounded soldiers alive. Grant is determined to keep fighting unlike previous Union commanders.",
            strategies: [
                {
                    name: "Push Through Despite Losses",
                    description: "Keep attacking regardless of casualties to maintain pressure",
                    explanation: "Grant's strategy is to use the Union's advantage in numbers and supplies. Keep fighting and don't give Lee time to rest or maneuver.",
                    pros: ["Maintains constant pressure", "Uses numerical advantage", "Prevents enemy maneuvers"],
                    cons: ["Heavy casualties expected", "Forest fires create danger", "Difficult to coordinate in thick woods"],
                    union: { win: true, soldierLoss: 55000, scoreGain: 400 },
                    confederacy: { win: false, soldierLoss: 35000, scoreGain: 200 }
                },
                {
                    name: "Try to Outmaneuver",
                    description: "Move around the Confederate flanks instead of direct assault",
                    explanation: "Even in the wilderness, there might be ways to get around the enemy instead of fighting through them head-on.",
                    pros: ["Avoids strongest defenses", "Could get behind enemy", "Saves casualties"],
                    cons: ["Difficult in thick terrain", "Lee is expert at this kind of fighting", "Takes more time"],
                    union: { win: false, soldierLoss: 45000, scoreGain: 250 },
                    confederacy: { win: true, soldierLoss: 30000, scoreGain: 450 }
                },
                {
                    name: "Wait for Better Terrain",
                    description: "Try to draw Lee out of the wilderness to more favorable ground",
                    explanation: "The wilderness helps Lee's smaller army. If you can get him to fight in open ground, your advantages in numbers and artillery would be greater.",
                    pros: ["Better terrain for larger army", "Reduces Lee's advantages", "Safer for your forces"],
                    cons: ["Gives Lee initiative", "Might look like retreating", "Lee might not cooperate"],
                    union: { win: false, soldierLoss: 35000, scoreGain: 200 },
                    confederacy: { win: true, soldierLoss: 25000, scoreGain: 400 }
                }
            ],
            results: {
                union_victory: "Despite heavy losses, Grant achieved his goal of keeping Lee's army engaged. Unlike previous Union commanders, Grant continued south instead of retreating.",
                confederacy_defeat: "Lee fought brilliantly in familiar terrain, but couldn't stop Grant's relentless advance. For the first time, a Union commander wouldn't be stopped by tactical defeats."
            },
            historical_notes: {
                general: "This battle marked a new phase of the war. Grant's strategy of continuous fighting, regardless of individual battle outcomes, began the final grinding down of Confederate resistance."
            }
        },
        {
            name: "Battle of Atlanta",
            date: "July 22, 1864",
            imageUrl: "images/battle_of_atlanta.jpg",
            imageCredit: "Kurz & Allison, 1888",
            context: "General Sherman's Union army threatens Atlanta, the industrial heart of the Confederacy. The city's factories produce weapons and supplies for Confederate armies, and its railroads connect the eastern and western parts of the South. Confederate General Hood has replaced the cautious Johnston and wants to attack Sherman's forces before they can capture the city.",
            strategies: [
                {
                    name: "Defend the City",
                    description: "Fortify Atlanta and make Sherman attack your prepared positions",
                    explanation: "Cities provide natural fortifications, and Atlanta's buildings and streets could help defenders. Make Sherman pay heavily for every block.",
                    pros: ["Uses urban defenses", "Protects vital industry", "Forces enemy to attack"],
                    cons: ["Could damage the city", "Civilians in danger", "If you lose, you lose everything"],
                    union: { win: true, soldierLoss: 30000, scoreGain: 550 },
                    confederacy: { win: false, soldierLoss: 45000, scoreGain: 150 }
                },
                {
                    name: "Attack Sherman's Supply Lines",
                    description: "Strike at the railroad lines bringing Sherman supplies",
                    explanation: "Armies need constant supplies of food and ammunition. If you can cut Sherman's supply lines, he might have to retreat.",
                    pros: ["Attacks enemy weakness", "Could force retreat", "Preserves your army"],
                    cons: ["Leaves Atlanta less defended", "Sherman might have enough supplies", "Cavalry raids are risky"],
                    union: { win: true, soldierLoss: 25000, scoreGain: 500 },
                    confederacy: { win: false, soldierLoss: 35000, scoreGain: 200 }
                },
                {
                    name: "Aggressive Field Battle",
                    description: "Attack Sherman's army in open battle before they reach Atlanta",
                    explanation: "Instead of waiting for a siege, attack Sherman while his army is spread out marching. This could catch them unprepared.",
                    pros: ["Takes initiative", "Could catch enemy unprepared", "Keeps battle away from city"],
                    cons: ["Sherman has more troops", "Risky without defensive advantages", "Could lose your army"],
                    union: { win: true, soldierLoss: 35000, scoreGain: 450 },
                    confederacy: { win: false, soldierLoss: 50000, scoreGain: 100 }
                }
            ],
            results: {
                union_victory: "Sherman's forces captured Atlanta after defeating Confederate attempts to stop them. The fall of this vital Confederate city was a huge blow to Southern morale.",
                confederacy_defeat: "Despite brave fighting, Confederate forces couldn't prevent the fall of Atlanta. The loss of this industrial center and railroad hub severely damaged the Confederate cause."
            },
            historical_notes: {
                general: "The Battle of Atlanta on July 22, 1864 was a major Union tactical victory, but the city didn't fall until September 2. Sherman's capture of Atlanta was crucial to Lincoln's re-election in 1864. His famous telegram 'Atlanta is ours, and fairly won' helped convince Northern voters that the war could be won."
            }
        },
        {
            name: "Battle of Appomattox Court House",
            date: "April 9, 1865",
            imageUrl: "images/surrender_appomattox.jpg",
            imageCredit: "Tom Lovell",
            context: "This is the end. Lee's Confederate army, hungry and exhausted, is surrounded near the small Virginia town of Appomattox Court House. Grant's forces have cut off their escape routes. Lee has perhaps 28,000 men left, while Grant has over 100,000. The Confederate cause is clearly lost, but some want to fight to the end while others think it's time to surrender and save lives.",
            strategies: [
                {
                    name: "Fight to the End",
                    description: "Continue fighting despite impossible odds",
                    explanation: "Some believe that surrender would dishonor the sacrifices already made. Fighting to the last man shows ultimate commitment to the cause.",
                    pros: ["Preserves honor", "Shows commitment", "Might inspire others"],
                    cons: ["Pointless loss of life", "Cause is already lost", "Could make peace terms worse"],
                    union: { win: true, soldierLoss: 15000, scoreGain: 600 },
                    confederacy: { win: false, soldierLoss: 25000, scoreGain: 50 }
                },
                {
                    name: "Attempt Breakout",
                    description: "Try to punch through Union lines and escape",
                    explanation: "Maybe there's still a chance to get away and continue the fight elsewhere. Even if most don't make it, some might escape to fight another day.",
                    pros: ["Might save part of the army", "Could continue resistance", "Avoids surrender"],
                    cons: ["Very unlikely to succeed", "Would cause more casualties", "Most would be captured anyway"],
                    union: { win: true, soldierLoss: 10000, scoreGain: 550 },
                    confederacy: { win: false, soldierLoss: 20000, scoreGain: 100 }
                },
                {
                    name: "Honorable Surrender",
                    description: "Negotiate surrender terms to save your soldiers' lives",
                    explanation: "The cause is lost, but the lives of your remaining soldiers are precious. An honorable surrender might allow them to go home to rebuild the South.",
                    pros: ["Saves lives", "Allows honorable end", "Soldiers can go home", "Begins healing process"],
                    cons: ["Admits defeat", "Ends the Confederate cause", "Some will see it as giving up"],
                    union: { win: true, soldierLoss: 0, scoreGain: 800 },
                    confederacy: { win: false, soldierLoss: 0, scoreGain: 400 }
                }
            ],
            results: {
                union_victory: "Lee chose to surrender to prevent further bloodshed. Grant's generous terms allowed Confederate soldiers to keep their horses and personal weapons, helping begin the healing process.",
                confederacy_defeat: "The Army of Northern Virginia surrendered, effectively ending the Civil War. Lee's decision to surrender rather than fight a hopeless battle saved thousands of lives."
            },
            historical_notes: {
                general: "Lee's surrender at Appomattox effectively ended the Civil War. Grant's generous terms and both commanders' dignified behavior helped set a tone for reunification rather than revenge."
            }
        }
    ];

    // Leader messages with educational content
    const leaderMessages = {
        union: {
            portrait: "üé©",
            name: "President Abraham Lincoln",
            message: "My fellow American,\n\nYou are about to take command of Union forces during our nation's greatest crisis. The <span class='vocab-term'>Civil War<span class='vocab-tooltip'><div class='vocab-definition'>A war fought between people from the same country</div></span></span> began because Southern states wanted to leave the United States to keep <span class='vocab-term'>slavery<span class='vocab-tooltip'><div class='vocab-definition'>The system where people could own other people and force them to work without pay</div></span></span> legal.\n\nAs a Union commander, you must make the same difficult decisions that real generals like Ulysses S. Grant and William T. Sherman faced. Every choice has consequences - for your soldiers, for civilians, and for the future of our country.\n\nRemember: we fight not just to win battles, but to preserve the idea that all people are created equal.\n\nGood luck, General.",
            objectives: [
                "Win 6 out of 10 major battles to restore the Union",
                "Learn about the real strategies used in the Civil War",
                "Understand how military decisions affected history",
                "Preserve as many soldiers as possible through smart tactics"
            ]
        },
        confederacy: {
            portrait: "üéñÔ∏è",
            name: "President Jefferson Davis",
            message: "Commander,\n\nThe Confederate States of America needs your leadership in our fight for independence. We face the difficult challenge of defending our new nation against a larger, more industrial enemy.\n\nYou will command forces like those led by Robert E. Lee and Stonewall Jackson. Though we have fewer soldiers and fewer factories, we have skilled officers and the advantage of fighting on our home territory.\n\nYour decisions will determine whether the Confederacy can achieve independence or if we will be forced back into the Union.\n\nThe South depends on you.",
            objectives: [
                "Win 5 out of 10 major battles to secure Confederate independence",
                "Use superior tactics to overcome Union advantages in numbers",
                "Learn about the challenges faced by Confederate commanders",
                "Understand the military and political goals of the Confederacy"
            ]
        }
    };

    // DOM Elements
    let elements = {};

    // Initialize game
    function initializeGame() {
        elements = {
            sideSelection: document.getElementById('sideSelection'),
            sideIntroduction: document.getElementById('sideIntroduction'),
            battleBriefing: document.getElementById('battleBriefing'),
            gameScreen: document.getElementById('gameScreen'),
            battleResultsModal: document.getElementById('battleResultsModal'),
            campaignLogModal: document.getElementById('campaignLogModal'),
            endGameSummary: document.getElementById('endGameSummary'),
            unionCard: document.getElementById('unionCard'),
            confederacyCard: document.getElementById('confederacyCard'),
            proceedToGame: document.getElementById('proceedToGame'),
            backToSideBtn: document.getElementById('backToSideBtn'),
            startOverBtn: document.getElementById('startOverBtn'),
            continueBattleBtn: document.getElementById('continueBattleBtn'),
            campaignLogBtn: document.getElementById('campaignLogBtn'),
            closeLogBtn: document.getElementById('closeLogBtn'),
            playAgainBtn: document.getElementById('playAgainBtn'),
            photoToggle: document.getElementById('photoToggle'),
            mapToggle: document.getElementById('mapToggle'),
            briefingImage: document.getElementById('briefingImage'),
            briefingMap: document.getElementById('briefingMap'),
            // Navigation elements
            navbarStats: document.getElementById('navbarStats'),
            navScore: document.getElementById('navScore'),
            navSoldiers: document.getElementById('navSoldiers'),
            navBattleNumber: document.getElementById('navBattleNumber'),
            navWins: document.getElementById('navWins'),
            campaignLogNavBtn: document.getElementById('campaignLogNavBtn'),
            startOverNavBtn: document.getElementById('startOverNavBtn'),
            vocabToggleNav: document.getElementById('vocabToggleNav'),
            settingsBtn: document.getElementById('settingsBtn'),
            settingsMenu: document.getElementById('settingsMenu'),
            vocabStatus: document.getElementById('vocabStatus')
        };

        // Check if this is first time playing - show introduction
        const hasSeenIntro = localStorage.getItem('civilWarIntroSeen');
        
        hideAllScreens();
        elements.sideSelection.style.display = 'block';
        
        if (!hasSeenIntro) {
            document.getElementById('civilWarIntro').style.display = 'block';
            // Hide the side cards
            document.querySelector('.sides-container').style.display = 'none';
            // Force re-render of vocabulary tooltips after display change
            setTimeout(() => {
                updateVocabularyDisplay();
                // Force browser to recalculate layout for tooltips
                const introVocabTerms = document.querySelectorAll('#civilWarIntro .vocab-term');
                introVocabTerms.forEach(term => {
                    term.style.position = 'relative'; // Ensure proper positioning context
                });
            }, 150);
        }
        
        setupEventListeners();
        updateVocabularyDisplay();
    }

    function setupEventListeners() {
        // Side selection
        elements.unionCard.addEventListener('click', () => selectSide('union'));
        elements.confederacyCard.addEventListener('click', () => selectSide('confederacy'));

        // Navigation
        elements.proceedToGame.addEventListener('click', startFirstBattle);
        elements.backToSideBtn.addEventListener('click', showSideSelection);
        elements.continueBattleBtn.addEventListener('click', continueToNextBattle);
        elements.playAgainBtn.addEventListener('click', resetGame);
        if (elements.startOverBtn) {
            elements.startOverBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to start over?')) resetGame();
            });
        }

        // Campaign log (check if elements exist)
        if (elements.campaignLogBtn) {
            elements.campaignLogBtn.addEventListener('click', showCampaignLog);
        }
        if (elements.closeLogBtn) {
            elements.closeLogBtn.addEventListener('click', closeCampaignLog);
        }

        // Settings (skip old vocab toggle - now handled in navigation)
        
        // Visual toggle controls
        elements.photoToggle.addEventListener('click', () => toggleVisualModeWithAnimation('photo'));
        elements.mapToggle.addEventListener('click', () => toggleVisualModeWithAnimation('map'));
        
        // Navigation bar controls
        elements.campaignLogNavBtn.addEventListener('click', showCampaignLog);
        elements.startOverNavBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to start over?')) resetGame();
        });
        elements.vocabToggleNav.addEventListener('click', toggleVocabularyHelp);
        
        // Settings dropdown
        elements.settingsBtn.addEventListener('click', toggleSettingsMenu);
        
        // Image credits toggle
        const creditsToggle = document.getElementById('creditsToggle');
        const creditsContent = document.getElementById('creditsContent');
        
        if (creditsToggle && creditsContent) {
            creditsToggle.addEventListener('click', () => {
                const isExpanded = creditsToggle.getAttribute('aria-expanded') === 'true';
                const newState = !isExpanded;
                
                // Update ARIA attributes
                creditsToggle.setAttribute('aria-expanded', newState);
                creditsContent.setAttribute('aria-hidden', !newState);
                
                // Toggle visual state
                if (newState) {
                    creditsContent.classList.add('expanded');
                    creditsToggle.querySelector('.credits-text').textContent = 'Hide Image Credits';
                } else {
                    creditsContent.classList.remove('expanded');
                    creditsToggle.querySelector('.credits-text').textContent = 'View Image Credits';
                }
            });
        }
        
        // Close settings when clicking outside
        document.addEventListener('click', (e) => {
            if (!elements.settingsBtn.contains(e.target) && !elements.settingsMenu.contains(e.target)) {
                elements.settingsMenu.classList.remove('show');
                elements.settingsBtn.setAttribute('aria-expanded', 'false');
            }
        });
        
        // Close vocabulary sidebar when clicking overlay
        const vocabOverlay = document.getElementById('vocabOverlay');
        if (vocabOverlay) {
            vocabOverlay.addEventListener('click', () => {
                if (settings.vocabHelp) {
                    toggleVocabularyHelp();
                }
            });
        }
        
        // Side selection accessibility - card and button support
        function addSideSelectionListeners() {
            const unionCard = document.getElementById('unionCard');
            const confederacyCard = document.getElementById('confederacyCard');
            
            // Click and keyboard support for Union card
            unionCard.addEventListener('click', () => selectSide('union'));
            unionCard.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    selectSide('union');
                }
            });
            
            // Click and keyboard support for Confederacy card
            confederacyCard.addEventListener('click', () => selectSide('confederacy'));
            confederacyCard.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    selectSide('confederacy');
                }
            });
            
            // Strategy button support
            const unionBtn = unionCard.querySelector('.select-strategy-btn');
            const confederacyBtn = confederacyCard.querySelector('.select-strategy-btn');
            
            unionBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                selectSide('union');
            });
            
            confederacyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                selectSide('confederacy');
            });
        }
        
        // Initialize side selection listeners after DOM is ready
        addSideSelectionListeners();

        // Close modal when clicking outside
        elements.campaignLogModal.addEventListener('click', (e) => {
            if (e.target === elements.campaignLogModal) {
                closeCampaignLog();
            }
        });
        
        // Enhanced modal keyboard handling
        document.addEventListener('keydown', (e) => {
            // ESC key closes modals and sidebar
            if (e.key === 'Escape') {
                if (elements.campaignLogModal.style.display === 'block') {
                    closeCampaignLog();
                } else if (elements.battleResultsModal.style.display === 'block') {
                    closeBattleResultsModal();
                } else if (settings.vocabHelp) {
                    toggleVocabularyHelp();
                } else if (elements.settingsMenu.classList.contains('show')) {
                    elements.settingsMenu.classList.remove('show');
                    elements.settingsBtn.setAttribute('aria-expanded', 'false');
                }
            }
        });
        
    }
    
    // Visual mode toggle functionality
    function toggleVisualMode(mode) {
        const photoToggle = elements.photoToggle;
        const mapToggle = elements.mapToggle;
        const briefingImage = elements.briefingImage;
        const briefingMap = elements.briefingMap;
        
        if (mode === 'photo') {
            photoToggle.classList.add('active');
            mapToggle.classList.remove('active');
            briefingImage.style.display = 'flex';
            briefingMap.style.display = 'none';
        } else if (mode === 'map') {
            photoToggle.classList.remove('active');
            mapToggle.classList.add('active');
            briefingImage.style.display = 'none';
            briefingMap.style.display = 'flex';
        }
    }
    
    // Create SVG mini-map for battle
    function createBattleMap(battleId) {
        const maps = {
            bull_run: `
                <svg viewBox="0 0 400 300" aria-label="Map of First Battle of Bull Run">
                    <rect width="400" height="300" fill="var(--color-cream-200)" />
                    <g stroke="var(--color-navy-600)" stroke-width="2" fill="none">
                        <!-- Bull Run Creek -->
                        <path d="M 50 150 Q 200 120 350 160" stroke="var(--color-blue-500)" stroke-width="3" />
                        <!-- Stone Bridge -->
                        <rect x="95" y="145" width="15" height="10" fill="var(--color-navy-800)" />
                        <!-- Union Forces -->
                        <rect x="80" y="100" width="40" height="20" fill="var(--color-blue-700)" />
                        <text x="100" y="90" text-anchor="middle" font-size="12" fill="var(--color-navy-800)">Union</text>
                        <!-- Confederate Forces -->
                        <rect x="280" y="180" width="40" height="20" fill="var(--color-error)" />
                        <text x="300" y="215" text-anchor="middle" font-size="12" fill="var(--color-navy-800)">Confederate</text>
                        <!-- Henry Hill -->
                        <circle cx="250" cy="150" r="20" fill="var(--color-gold-400)" opacity="0.7" />
                        <text x="250" y="155" text-anchor="middle" font-size="10" fill="var(--color-navy-800)">Henry Hill</text>
                    </g>
                </svg>
            `,
            gettysburg: `
                <svg viewBox="0 0 400 300" aria-label="Map of Battle of Gettysburg">
                    <rect width="400" height="300" fill="var(--color-cream-200)" />
                    <g stroke="var(--color-navy-600)" stroke-width="2" fill="none">
                        <!-- Cemetery Hill -->
                        <circle cx="200" cy="120" r="25" fill="var(--color-gold-400)" opacity="0.7" />
                        <text x="200" y="95" text-anchor="middle" font-size="12" fill="var(--color-navy-800)">Cemetery Hill</text>
                        <!-- Union Lines -->
                        <path d="M 180 120 Q 200 180 220 240" stroke="var(--color-blue-700)" stroke-width="4" />
                        <!-- Confederate Lines -->
                        <path d="M 100 100 Q 150 150 120 200 Q 180 220 240 200 Q 280 180 300 140" stroke="var(--color-error)" stroke-width="4" />
                        <!-- Little Round Top -->
                        <circle cx="160" cy="220" r="15" fill="var(--color-gold-400)" opacity="0.7" />
                        <text x="160" y="245" text-anchor="middle" font-size="10" fill="var(--color-navy-800)">Little Round Top</text>
                        <!-- Big Round Top -->
                        <circle cx="140" cy="240" r="18" fill="var(--color-gold-400)" opacity="0.7" />
                        <text x="90" y="260" text-anchor="middle" font-size="10" fill="var(--color-navy-800)">Big Round Top</text>
                    </g>
                </svg>
            `,
            antietam: `
                <svg viewBox="0 0 400 300" aria-label="Map of Battle of Antietam">
                    <rect width="400" height="300" fill="var(--color-cream-200)" />
                    <g stroke="var(--color-navy-600)" stroke-width="2" fill="none">
                        <!-- Antietam Creek -->
                        <path d="M 150 50 Q 180 150 150 250" stroke="var(--color-blue-500)" stroke-width="4" />
                        <!-- Burnside Bridge -->
                        <rect x="145" y="200" width="15" height="8" fill="var(--color-navy-800)" />
                        <text x="170" y="215" font-size="10" fill="var(--color-navy-800)">Burnside Bridge</text>
                        <!-- Union Forces -->
                        <rect x="80" y="120" width="50" height="15" fill="var(--color-blue-700)" />
                        <rect x="70" y="180" width="50" height="15" fill="var(--color-blue-700)" />
                        <!-- Confederate Forces -->
                        <rect x="200" y="140" width="50" height="15" fill="var(--color-error)" />
                        <!-- Sharpsburg -->
                        <circle cx="220" cy="120" r="12" fill="var(--color-navy-800)" />
                        <text x="220" y="105" text-anchor="middle" font-size="10" fill="var(--color-navy-800)">Sharpsburg</text>
                    </g>
                </svg>
            `
        };
        
        return maps[battleId] || `
            <svg viewBox="0 0 400 300" aria-label="Generic battle map">
                <rect width="400" height="300" fill="var(--color-cream-200)" />
                <g stroke="var(--color-navy-600)" stroke-width="2" fill="none">
                    <text x="200" y="150" text-anchor="middle" font-size="16" fill="var(--color-navy-800)">Battle Map</text>
                    <text x="200" y="170" text-anchor="middle" font-size="12" fill="var(--color-navy-600)">Detailed map not available</text>
                </g>
            </svg>
        `;
    }
    
    // Load asset manifest
    function getAssetManifest() {
        const manifestScript = document.getElementById('assetManifest');
        if (manifestScript) {
            return JSON.parse(manifestScript.textContent);
        }
        return [];
    }
    
    // Enhanced screen transitions with staggered animations
    function showScreenWithAnimation(screenElement, animationType = 'fadeIn') {
        if (!screenElement) return;
        
        // Hide all screens first
        hideAllScreens();
        
        // Show the target screen
        screenElement.style.display = 'block';
        
        // Add animation class
        screenElement.classList.add(`animate-${animationType}`);
        
        // Find and animate child elements with stagger
        const animatableElements = screenElement.querySelectorAll('.side-card, .choice-option, .summary-stat, .timeline-item');
        animatableElements.forEach((el, index) => {
            el.style.animationDelay = `${index * 0.1}s`;
            el.classList.add('animate-slide-in-left');
        });
        
        // Clean up animation classes after animation completes
        setTimeout(() => {
            screenElement.classList.remove(`animate-${animationType}`);
            animatableElements.forEach(el => {
                el.classList.remove('animate-slide-in-left');
                el.style.animationDelay = '';
            });
        }, 800);
    }
    
    // Enhanced transition for visual mode toggle
    function toggleVisualModeWithAnimation(mode) {
        const photoToggle = elements.photoToggle;
        const mapToggle = elements.mapToggle;
        const briefingImage = elements.briefingImage;
        const briefingMap = elements.briefingMap;
        
        if (mode === 'photo') {
            photoToggle.classList.add('active');
            mapToggle.classList.remove('active');
            briefingMap.style.display = 'none';
            briefingImage.style.display = 'flex';
            briefingImage.classList.add('animate-scale-in');
        } else if (mode === 'map') {
            photoToggle.classList.remove('active');
            mapToggle.classList.add('active');
            briefingImage.style.display = 'none';
            briefingMap.style.display = 'flex';
            briefingMap.classList.add('animate-scale-in');
        }
        
        // Clean up animation classes
        setTimeout(() => {
            briefingImage.classList.remove('animate-scale-in');
            briefingMap.classList.remove('animate-scale-in');
        }, 500);
    }

    // Focus trap for modals
    function trapFocus(modal) {
        const focusableElements = modal.querySelectorAll(
            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        const firstFocusable = focusableElements[0];
        const lastFocusable = focusableElements[focusableElements.length - 1];
        
        modal.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                if (e.shiftKey) {
                    if (document.activeElement === firstFocusable) {
                        lastFocusable.focus();
                        e.preventDefault();
                    }
                } else {
                    if (document.activeElement === lastFocusable) {
                        firstFocusable.focus();
                        e.preventDefault();
                    }
                }
            }
        });
        
        // Focus first element when modal opens
        firstFocusable?.focus();
    }

    function selectSide(side) {
        gameState.side = side;
        
        const leader = leaderMessages[side];
        document.getElementById('leaderPortrait').textContent = leader.portrait;
        document.getElementById('leaderName').textContent = leader.name;
        document.getElementById('leaderMessage').innerHTML = leader.message;
        
        const objectivesList = document.getElementById('objectivesList');
        objectivesList.innerHTML = '';
        leader.objectives.forEach(objective => {
            const item = document.createElement('div');
            item.className = 'objective-item';
            item.textContent = objective;
            objectivesList.appendChild(item);
        });
        
        showSideIntroduction();
    }

    function showSideSelection() {
        gameState.side = null;
        hideAllScreens();
        elements.sideSelection.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showSideIntroduction() {
        hideAllScreens();
        elements.sideIntroduction.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function startFirstBattle() {
        gameState.soldiers = gameState.side === 'union' ? 1500000 : 1000000;
        gameState.currentBattle = 0;
        gameState.score = 0;
        gameState.wins = 0;
        gameState.losses = 0;
        gameState.battleHistory = [];
        
        showBattleBriefing();
    }

    function showBattleBriefing() {
        const battle = battles[gameState.currentBattle];
        const assets = getAssetManifest();
        
        document.getElementById('briefingTitle').textContent = battle.name;
        document.getElementById('briefingDate').textContent = battle.date;
        document.getElementById('contextText').innerHTML = battle.context;
        
        // Find matching asset for this battle
        // Create a simple mapping based on battle index since assets are in order
        let battleAsset = assets[gameState.currentBattle];
        
        // If no direct index match, try name matching as fallback
        if (!battleAsset) {
            battleAsset = assets.find(asset => {
                const assetName = asset.id.replace(/_/g, ' ').toLowerCase();
                const battleName = battle.name.toLowerCase();
                const match = battleName.includes(assetName) || 
                             (assetName.includes('bull') && battleName.includes('bull')) ||
                             (assetName.includes('antietam') && battleName.includes('antietam')) ||
                             (assetName.includes('gettysburg') && battleName.includes('gettysburg'));
                return match;
            });
        }
        
        // Final fallback to first asset
        if (!battleAsset) {
            battleAsset = assets[0];
        }
        
        // Asset selection complete
        
        // Update battle image with high-quality asset
        const briefingImage = elements.briefingImage;
        const briefingMap = elements.briefingMap;
        
        if (!battleAsset) {
            briefingImage.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--color-text-secondary); background: var(--color-surface-secondary); border-radius: var(--radius-xl);">
                    <div style="font-size: 3em; margin-bottom: 10px;">‚ùå</div>
                    <p style="font-weight: 600;">No Image Asset Found</p>
                    <p style="font-size: 0.9em; margin-top: 5px;">${battle.name}</p>
                </div>
            `;
            return;
        }
        
        if (battleAsset && briefingImage) {
            // Show loading state immediately
            briefingImage.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--color-text-secondary);">
                    <div style="font-size: 2em; margin-bottom: 10px;">üì∑</div>
                    <p>Loading image...</p>
                </div>
            `;
            
            // Direct image loading without CORS issues
            const imageUrl = battleAsset.url;
            
            // Set image directly in HTML to avoid CORS issues
            briefingImage.innerHTML = `
                <img src="${imageUrl}" 
                     alt="${battleAsset.title}" 
                     loading="lazy" 
                     decoding="async"
                     style="transition: opacity 0.3s ease; width: 100%; height: 100%; object-fit: cover;"
                     onload="this.style.opacity='1'"
                     onerror="this.onerror=null; this.src='data:image/svg+xml;base64,${btoa(`<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg"><rect width="400" height="300" fill="#2a2a2a"/><text x="200" y="120" fill="white" text-anchor="middle" font-size="18">Historical Image</text><text x="200" y="150" fill="white" text-anchor="middle" font-size="16">${battle.name}</text><text x="200" y="180" fill="white" text-anchor="middle" font-size="14">${battle.date}</text></svg>`)}'; this.style.opacity='1';">
                <span class="image-credit" style="position: absolute; bottom: 8px; left: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">${battleAsset.credit} ‚Ä¢ ${battleAsset.source}</span>
            `;
        } else {
            briefingImage.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--color-text-secondary);">
                    <div style="font-size: 3em; margin-bottom: 10px;">‚öîÔ∏è</div>
                    <p>${battle.name}</p>
                    <p style="font-size: 0.9em; margin-top: 5px;">${battle.date}</p>
                </div>
            `;
        }
        
        // Create and populate battle map
        const battleId = battleAsset ? battleAsset.id : 'generic';
        briefingMap.innerHTML = createBattleMap(battleId);
        
        // Reset to photo view by default
        toggleVisualModeWithAnimation('photo');
        
        // Create strategy choices with collapsible details
        const choicesList = document.getElementById('choicesList');
        choicesList.innerHTML = '';
        
        battle.strategies.forEach((strategy, index) => {
            const choiceDiv = document.createElement('div');
            choiceDiv.className = `choice-option ${index === 0 ? 'aggressive' : index === 1 ? 'defensive' : 'tactical'}`;
            choiceDiv.innerHTML = `
                <div class="choice-header">
                    <div class="choice-name">${strategy.name}</div>
                    <div class="expand-icon">‚ñº</div>
                </div>
                <div class="choice-description">${strategy.description}</div>
                <div class="choice-details">
                    <div class="choice-explanation">${strategy.explanation}</div>
                    <div class="choice-pros-cons">
                        <div class="pros">
                            <div class="pros-title">‚úì Advantages:</div>
                            <ul>
                                ${strategy.pros.map(pro => `<li>${pro}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="cons">
                            <div class="cons-title">‚úó Risks:</div>
                            <ul>
                                ${strategy.cons.map(con => `<li>${con}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            // Add click handler for expanding details
            choiceDiv.addEventListener('click', (e) => {
                // Check if they clicked the expand area (not trying to make a decision)
                const isExpanded = choiceDiv.classList.contains('expanded');
                
                // First click expands, second click makes decision
                if (!isExpanded) {
                    // Collapse all other choices
                    document.querySelectorAll('.choice-option').forEach(option => {
                        option.classList.remove('expanded');
                    });
                    
                    // Expand this choice
                    choiceDiv.classList.add('expanded');
                } else {
                    // Make the decision
                    makeDecision(index);
                }
            });
            
            choicesList.appendChild(choiceDiv);
        });
        
        // Add instruction text
        const instructionDiv = document.createElement('div');
        instructionDiv.className = 'click-to-expand';
        instructionDiv.innerHTML = 'üí° <strong>How it works:</strong> First click = see details ‚Ä¢ Second click = make decision';
        choicesList.appendChild(instructionDiv);
        
        hideAllScreens();
        elements.battleBriefing.style.display = 'block';
        updateGameDisplay();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        updateVocabularyDisplay();
    }

    function makeDecision(strategyIndex) {
        const battle = battles[gameState.currentBattle];
        const strategy = battle.strategies[strategyIndex];
        const result = strategy[gameState.side];
        
        applyBattleResult(result, strategy);
    }

    function applyBattleResult(result, strategy) {
        const battle = battles[gameState.currentBattle];
        
        if (result.win) {
            gameState.wins++;
        } else {
            gameState.losses++;
        }
        
        gameState.soldiers -= result.soldierLoss;
        gameState.soldiers = Math.max(0, gameState.soldiers);
        gameState.score += result.scoreGain;
        
        gameState.battleHistory.push({
            battleNumber: gameState.currentBattle + 1,
            name: battle.name,
            strategy: strategy.name,
            result: result.win ? 'Victory' : 'Defeat',
            casualties: result.soldierLoss
        });

        showBattleResults(result, strategy);
    }

    function showBattleResults(result, strategy) {
        const battle = battles[gameState.currentBattle];
        
        // Set outcome
        const outcomeEl = document.getElementById('battleOutcome');
        outcomeEl.textContent = result.win ? 'VICTORY!' : 'DEFEAT';
        outcomeEl.className = result.win ? 'battle-outcome battle-victory' : 'battle-outcome battle-defeat';
        
        // Set results summary (the new prominent section)
        document.getElementById('resultIcon').textContent = result.win ? 'üèÜ' : 'üíÄ';
        document.getElementById('resultText').textContent = result.win ? 
            'Your strategy succeeded!' : 'Your strategy was defeated.';
        
        document.getElementById('casualtiesSummary').textContent = `${result.soldierLoss.toLocaleString()} lost`;
        document.getElementById('scoreSummary').textContent = `+${result.scoreGain} points`;
        document.getElementById('armySummary').textContent = `${gameState.soldiers.toLocaleString()} remain`;
        
        // Create detailed explanation with highlighted outcome
        const sideResult = gameState.side === 'union' ? 
            (result.win ? 'union_victory' : 'union_loss') : 
            (result.win ? 'confederacy_victory' : 'confederacy_defeat');
        
        const outcomeHighlight = result.win ? 
            '<span class="outcome-highlight victory-highlight">üéâ YOU WON THIS BATTLE! üéâ</span>' :
            '<span class="outcome-highlight defeat-highlight">üíî You lost this battle üíî</span>';
        
        document.getElementById('explanationText').innerHTML = `
            <div style="text-align: center; margin-bottom: 20px;">
                ${outcomeHighlight}
            </div>
            <p><strong>Your Strategy:</strong> ${strategy.name}</p>
            <p><strong>What Happened:</strong> ${battle.results[sideResult] || 'The battle outcome was determined by your strategic choice.'}</p>
            <p style="margin-top: 15px;"><strong>Why this happened:</strong> ${strategy.explanation.replace(/<[^>]*>/g, '')}</p>
        `;
        
        document.getElementById('historicalNote').textContent = battle.historical_notes.general;
        
        // Update button text
        if (gameState.currentBattle + 1 >= battles.length || gameState.soldiers <= 0) {
            elements.continueBattleBtn.textContent = 'View Final Results';
        } else {
            elements.continueBattleBtn.textContent = 'Continue to Next Battle';
        }
        
        updateGameDisplay();
        
        // Show game screen (revert to working approach)
        hideAllScreens();
        elements.gameScreen.style.display = 'block';
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function continueToNextBattle() {
        // Continue from game screen to next battle
        
        gameState.currentBattle++;
        if (gameState.currentBattle >= battles.length || gameState.soldiers <= 0 || shouldEndGame()) {
            endGame();
        } else {
            showBattleBriefing();
        }
    }

    function shouldEndGame() {
        const requiredWins = gameState.side === 'union' ? 6 : 5;
        const battlesRemaining = battles.length - (gameState.currentBattle + 1);
        
        // End if we've won enough battles
        if (gameState.wins >= requiredWins) return true;
        
        // End if we can't possibly win
        if (gameState.wins + battlesRemaining < requiredWins) return true;
        
        // End if we've run out of soldiers
        if (gameState.soldiers <= 0) return true;
        
        return false;
    }

    function updateGameDisplay() {
        // Update old display elements (for compatibility)
        const scoreEl = document.getElementById('score');
        const soldiersEl = document.getElementById('soldiers');
        const winsEl = document.getElementById('wins');
        const battleNumberEl = document.getElementById('battleNumber');
        
        if (scoreEl) scoreEl.textContent = gameState.score.toLocaleString();
        if (soldiersEl) soldiersEl.textContent = gameState.soldiers.toLocaleString();
        if (winsEl) winsEl.textContent = gameState.wins;
        if (battleNumberEl) battleNumberEl.textContent = gameState.currentBattle + 1;
        
        // Update navbar stats
        // Navbar stats temporarily disabled - will implement leaderboard later
        // if (elements.navScore) elements.navScore.textContent = gameState.score.toLocaleString();
        // if (elements.navSoldiers) elements.navSoldiers.textContent = gameState.soldiers.toLocaleString();
        // if (elements.navWins) elements.navWins.textContent = gameState.wins;
        // if (elements.navBattleNumber) elements.navBattleNumber.textContent = gameState.currentBattle + 1;
        
        // Show/hide navbar stats during gameplay
        const isInGame = gameState.currentBattle > 0 || gameState.side;
        if (isInGame) {
            // Navbar stats temporarily disabled - will implement leaderboard later
            // if (elements.navbarStats) elements.navbarStats.style.display = 'flex';
            if (elements.campaignLogNavBtn) elements.campaignLogNavBtn.style.display = 'block';
            
            // Show game actions section in menu
            const gameActionsSection = document.getElementById('gameActionsSection');
            const gameActionsDiv = document.getElementById('gameActionsDiv');
            if (gameActionsSection) gameActionsSection.style.display = 'block';
            if (gameActionsDiv) gameActionsDiv.style.display = 'block';
        } else {
            // Navbar stats temporarily disabled - will implement leaderboard later
            // if (elements.navbarStats) elements.navbarStats.style.display = 'none';
            if (elements.campaignLogNavBtn) elements.campaignLogNavBtn.style.display = 'none';
            
            // Hide game actions section in menu
            const gameActionsSection = document.getElementById('gameActionsSection');
            const gameActionsDiv = document.getElementById('gameActionsDiv');
            if (gameActionsSection) gameActionsSection.style.display = 'none';
            if (gameActionsDiv) gameActionsDiv.style.display = 'none';
        }
    }
    
    function toggleSettingsMenu() {
        const menu = elements.settingsMenu;
        const btn = elements.settingsBtn;
        const isOpen = menu.classList.contains('show');
        
        if (isOpen) {
            menu.classList.remove('show');
            btn.setAttribute('aria-expanded', 'false');
        } else {
            menu.classList.add('show');
            btn.setAttribute('aria-expanded', 'true');
        }
    }

    function endGame() {
        const requiredWins = gameState.side === 'union' ? 6 : 5;
        const victory = gameState.wins >= requiredWins && gameState.soldiers > 0;
        
        showEndGameSummary(victory);
    }

    function showEndGameSummary(victory) {
        hideAllScreens();
        
        const banner = document.getElementById('outcomeBanner');
        banner.className = victory ? 'outcome-banner victory-banner' : 'outcome-banner defeat-banner';
        
        document.getElementById('outcomeTitle').textContent = victory ? 'VICTORY!' : 'DEFEAT';
        document.getElementById('outcomeSubtitle').textContent = victory ? 
            (gameState.side === 'union' ? 'The Union is Preserved' : 'Confederate Independence Achieved') :
            (gameState.side === 'union' ? 'The Rebellion Continues' : 'The Confederacy Falls');
        
        const startingSoldiers = gameState.side === 'union' ? 1500000 : 1000000;
        const casualtyRate = Math.round(((startingSoldiers - gameState.soldiers) / startingSoldiers) * 100);
        
        document.getElementById('finalStatsText').innerHTML = `
            <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                <h3 style="color: #ffd700; margin-bottom: 15px;">Your Performance:</h3>
                <p><strong>Final Score:</strong> ${gameState.score.toLocaleString()} points</p>
                <p><strong>Battles Won:</strong> ${gameState.wins} out of ${gameState.currentBattle} fought</p>
                <p><strong>Soldiers Lost:</strong> ${(startingSoldiers - gameState.soldiers).toLocaleString()} (${casualtyRate}% casualty rate)</p>
                <p><strong>Side:</strong> ${gameState.side === 'union' ? 'üá∫üá∏ Union' : 'üè¥ Confederacy'}</p>
                
                <h3 style="color: #ffd700; margin: 20px 0 10px 0;">What You Learned:</h3>
                <p>You experienced the same difficult decisions that real Civil War commanders faced. Each battle presented unique challenges based on terrain, troop positions, and available resources.</p>
                
                <p style="margin-top: 15px;">
                    ${victory ? 
                        'Congratulations! Your strategic decisions led to victory. In the real Civil War, these battles helped determine the future of the United States.' :
                        'Although you didn\'t achieve victory, you learned about the challenges of Civil War command. Every battle taught lessons that real generals had to learn the hard way.'
                    }
                </p>
                
                <h3 style="color: #ffd700; margin: 20px 0 10px 0;">Battle Summary:</h3>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                    ${gameState.battleHistory.map(battle => 
                        `<div style="margin: 5px 0; padding: 5px; border-left: 3px solid ${battle.result === 'Victory' ? '#10b981' : '#dc2626'};">
                            <strong>${battle.name}:</strong> ${battle.result === 'Victory' ? '‚úÖ' : '‚ùå'} ${battle.result} 
                            (${battle.strategy}, ${battle.casualties.toLocaleString()} casualties)
                        </div>`
                    ).join('')}
                </div>
            </div>
        `;
        
        elements.endGameSummary.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function hideAllScreens() {
        elements.sideSelection.style.display = 'none';
        elements.sideIntroduction.style.display = 'none';
        elements.battleBriefing.style.display = 'none';
        elements.gameScreen.style.display = 'none';
        elements.battleResultsModal.style.display = 'none';
        elements.campaignLogModal.style.display = 'none';
        elements.endGameSummary.style.display = 'none';
    }

    function showCampaignLog() {
        updateCampaignLog();
        elements.campaignLogModal.style.display = 'block';
        
        // Apply focus trap
        setTimeout(() => {
            trapFocus(elements.campaignLogModal);
        }, 100);
    }

    function closeCampaignLog() {
        elements.campaignLogModal.style.display = 'none';
    }
    
    function closeBattleResultsModal() {
        elements.battleResultsModal.style.display = 'none';
        elements.battleResultsModal.classList.remove('show');
    }

    function updateCampaignLog() {
        // Update overview stats
        document.getElementById('battlesCompleted').textContent = gameState.battleHistory.length;
        document.getElementById('winsCount').textContent = gameState.wins;
        document.getElementById('currentScore').textContent = gameState.score.toLocaleString();

        // Update victory progress
        const requiredWins = gameState.side === 'union' ? 6 : 5;
        const progressPercent = Math.min((gameState.wins / requiredWins) * 100, 100);
        document.getElementById('victoryFill').style.width = `${progressPercent}%`;
        document.getElementById('victoryText').textContent = `${gameState.wins} of ${requiredWins} wins needed`;

        // Update battle timeline
        const timelineContainer = document.getElementById('timelineContainer');
        timelineContainer.innerHTML = '';

        if (gameState.battleHistory.length === 0) {
            timelineContainer.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No battles fought yet.</p>';
        } else {
            gameState.battleHistory.forEach(battle => {
                const timelineItem = document.createElement('div');
                timelineItem.className = `timeline-item ${battle.result.toLowerCase()}`;
                timelineItem.innerHTML = `
                    <div class="timeline-battle">Battle ${battle.battleNumber}: ${battle.name}</div>
                    <div class="timeline-details">
                        Strategy: ${battle.strategy}<br>
                        Result: ${battle.result === 'Victory' ? '‚úÖ' : '‚ùå'} ${battle.result}<br>
                        Casualties: ${battle.casualties.toLocaleString()} soldiers
                    </div>
                `;
                timelineContainer.appendChild(timelineItem);
            });
        }

        // Update strategy analysis
        updateStrategyAnalysis();
    }

    function updateStrategyAnalysis() {
        const strategyStats = document.getElementById('strategyStats');
        
        if (gameState.battleHistory.length === 0) {
            strategyStats.innerHTML = '<p style="text-align: center; color: #888;">Strategy analysis will appear after battles.</p>';
            return;
        }

        // Count strategy types used
        const strategies = {
            aggressive: { count: 0, wins: 0, names: ['Direct Attack', 'Immediate Counterattack', 'Coordinated Assault', 'Attack the Center', 'Direct Assault', 'Exploit the Gap', 'Push Through Despite Losses', 'Aggressive Field Battle', 'Fight to the End'] },
            defensive: { count: 0, wins: 0, names: ['Defensive Position', 'Form Defensive Lines', 'Hold the High Ground', 'Artillery Bombardment First', 'Hold Defensive Positions', 'Steady Pressure', 'Defensive Stand', 'Wait for Better Terrain', 'Defend the City'] },
            tactical: { count: 0, wins: 0, names: ['Flanking Movement', 'Strategic Retreat', 'Cautious Advance', 'Focus on Escape Routes', 'Flanking Maneuver', 'Find Alternative Crossing', 'Attack While Enemy is Divided', 'Withdraw to Open Ground', 'Try to Outmaneuver', 'Attack Sherman\'s Supply Lines', 'Attempt Breakout', 'Honorable Surrender'] }
        };

        gameState.battleHistory.forEach(battle => {
            let strategyType = 'tactical'; // default
            
            if (strategies.aggressive.names.includes(battle.strategy)) {
                strategyType = 'aggressive';
            } else if (strategies.defensive.names.includes(battle.strategy)) {
                strategyType = 'defensive';
            }

            strategies[strategyType].count++;
            if (battle.result === 'Victory') {
                strategies[strategyType].wins++;
            }
        });

        strategyStats.innerHTML = `
            <div class="strategy-type">
                <div class="strategy-name">Aggressive</div>
                <div class="strategy-count" style="color: #dc2626;">${strategies.aggressive.count}</div>
                <div class="strategy-success">${strategies.aggressive.count > 0 ? Math.round((strategies.aggressive.wins / strategies.aggressive.count) * 100) : 0}% success rate</div>
            </div>
            <div class="strategy-type">
                <div class="strategy-name">Defensive</div>
                <div class="strategy-count" style="color: #3b82f6;">${strategies.defensive.count}</div>
                <div class="strategy-success">${strategies.defensive.count > 0 ? Math.round((strategies.defensive.wins / strategies.defensive.count) * 100) : 0}% success rate</div>
            </div>
            <div class="strategy-type">
                <div class="strategy-name">Tactical</div>
                <div class="strategy-count" style="color: #7c3aed;">${strategies.tactical.count}</div>
                <div class="strategy-success">${strategies.tactical.count > 0 ? Math.round((strategies.tactical.wins / strategies.tactical.count) * 100) : 0}% success rate</div>
            </div>
        `;
    }


    function toggleVocabularyHelp() {
        settings.vocabHelp = !settings.vocabHelp;
        // Vocabulary help toggled
        
        // Update the status indicator in the menu
        const vocabStatus = document.getElementById('vocabStatus');
        if (vocabStatus) {
            vocabStatus.textContent = settings.vocabHelp ? 'ON' : 'OFF';
            vocabStatus.classList.toggle('active', settings.vocabHelp);
        }
        
        // Update the navigation vocabulary button state
        if (elements.vocabToggleNav) {
            elements.vocabToggleNav.setAttribute('aria-pressed', settings.vocabHelp.toString());
            elements.vocabToggleNav.style.background = settings.vocabHelp ? 'var(--color-primary-alpha)' : '';
        }
        
        // Toggle vocabulary sidebar with proper layout handling
        const sidebar = document.getElementById('vocabSidebar');
        const overlay = document.getElementById('vocabOverlay');
        
        if (sidebar) {
            // Toggling sidebar visibility
            if (settings.vocabHelp) {
                // Show sidebar
                document.body.classList.add('vocab-open');
                sidebar.style.display = 'block';
                sidebar.classList.add('show');
                
                // Show overlay on mobile
                if (overlay) {
                    overlay.classList.add('show');
                }
                
                // Close menu if open
                if (elements.settingsMenu) {
                    elements.settingsMenu.classList.remove('show');
                    elements.settingsBtn.setAttribute('aria-expanded', 'false');
                }
            } else {
                // Hide sidebar
                document.body.classList.remove('vocab-open');
                sidebar.classList.remove('show');
                
                // Hide overlay
                if (overlay) {
                    overlay.classList.remove('show');
                }
                
                setTimeout(() => {
                    if (!settings.vocabHelp) {
                        sidebar.style.display = 'none';
                    }
                }, 300);
            }
        }
        
        updateVocabularyDisplay();
    }

    function updateVocabularyDisplay() {
        const vocabTerms = document.querySelectorAll('.vocab-term');
        vocabTerms.forEach(term => {
            if (settings.vocabHelp) {
                term.style.borderBottom = '2px dotted #ffd700';
                term.style.cursor = 'help';
            } else {
                term.style.borderBottom = 'none';
                term.style.cursor = 'inherit';
            }
        });
    }

    function hideIntroduction() {
        // Mark introduction as seen
        localStorage.setItem('civilWarIntroSeen', 'true');
        
        // Hide introduction and show side selection
        document.getElementById('civilWarIntro').style.display = 'none';
        
        // Show the side cards
        document.querySelector('.sides-container').style.display = 'flex';
        
        // Update vocabulary display for new content
        updateVocabularyDisplay();
    }

    function resetGame() {
        gameState = {
            side: null,
            currentBattle: 0,
            score: 0,
            soldiers: 0,
            wins: 0,
            losses: 0,
            battleHistory: []
        };
        
        showSideSelection();
    }

    // For testing - reset introduction flag
    function resetIntroduction() {
        localStorage.removeItem('civilWarIntroSeen');
        location.reload();
    }

    // Performance utilities
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    function throttle(func, limit) {
        let inThrottle;
        return function() {
            const args = arguments;
            const context = this;
            if (!inThrottle) {
                func.apply(context, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        }
    }
    
    // Performance monitoring
    function measurePerformance(name, fn) {
        if ('performance' in window && 'mark' in performance) {
            performance.mark(`${name}-start`);
            const result = fn();
            performance.mark(`${name}-end`);
            performance.measure(name, `${name}-start`, `${name}-end`);
            return result;
        }
        return fn();
    }
    
    // Optimize frequent DOM updates
    const debouncedUpdateDisplay = debounce(updateGameDisplay, 100);
    const debouncedVocabUpdate = debounce(updateVocabularyDisplay, 150);

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeGame);
    } else {
        initializeGame();
    }
</script>

<!-- Version Display -->
<div class="version-info">
    <span>Civil War Battle Simulation v1.0.0</span>
</div>

</body>
</html>
