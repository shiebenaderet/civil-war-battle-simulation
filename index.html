<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civil War Battle Simulation - Educational Edition</title>

    <!-- Performance & Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="no-referrer-when-downgrade">

    <!-- DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">

    <!-- Asset Manifest - Public Domain Civil War Images -->
    <script type="application/json" id="assetManifest">[
        {
            "id": "fort_sumter",
            "title": "Battle of Fort Sumter",
            "url": "images/battle_of_fort_sumter.jpg",
            "credit": "Currier & Ives",
            "license": "Public Domain",
            "source": "Library of Congress",
            "note": "Download from: https://www.battlefields.org/learn/maps/charleston-harbor-sc-bombardment-fort-sumter"
        },
        {
            "id": "bull_run",
            "title": "First Battle of Bull Run",
            "url": "images/battle_of_bull_run.jpg",
            "credit": "Currier & Ives",
            "license": "Public Domain",
            "source": "Library of Congress",
            "mapUrl": "https://commons.wikimedia.org/wiki/Special:Redirect/file/First_Bull_Run_July21_1400.png?width=900",
            "mapCredit": "Map by Hal Jespersen, cwmaps.com",
            "mapLicense": "CC BY 3.0"
        },
        {
            "id": "shiloh",
            "title": "Battle of Shiloh",
            "url": "images/battle_of_shiloh.jpg",
            "credit": "Thure de Thulstrup",
            "license": "Public Domain",
            "source": "Library of Congress",
            "mapUrl": "https://commons.wikimedia.org/wiki/Special:Redirect/file/Shiloh_Battle_Apr6pm.png?width=900",
            "mapCredit": "Map by Hal Jespersen, cwmaps.com",
            "mapLicense": "CC BY 3.0"
        },
        {
            "id": "antietam",
            "title": "Battle of Antietam",
            "url": "images/battle_of_antietam.jpg",
            "credit": "Alexander Gardner",
            "license": "Public Domain",
            "source": "National Archives",
            "mapUrl": "https://commons.wikimedia.org/wiki/Special:Redirect/file/Antietam_Overview.png?width=900",
            "mapCredit": "Map by Hal Jespersen, cwmaps.com",
            "mapLicense": "CC BY 3.0"
        },
        {
            "id": "fredericksburg",
            "title": "Battle of Fredericksburg",
            "url": "images/battle_of_fredericksburg.jpg",
            "credit": "Kurz & Allison",
            "license": "Public Domain",
            "source": "Library of Congress",
            "mapUrl": "https://commons.wikimedia.org/wiki/Special:Redirect/file/Fredericksburg-Overview-2.png?width=900",
            "mapCredit": "Map by Hal Jespersen, cwmaps.com",
            "mapLicense": "CC BY 3.0"
        },
        {
            "id": "chancellorsville",
            "title": "Battle of Chancellorsville",
            "url": "images/battle_of_chancellorsville.jpg",
            "credit": "Jedediah Hotchkiss",
            "license": "Public Domain",
            "source": "National Archives",
            "mapUrl": "https://commons.wikimedia.org/wiki/Special:Redirect/file/Battle_of_Chancellorsville.png?width=900",
            "mapCredit": "Map by Hal Jespersen, cwmaps.com",
            "mapLicense": "CC BY 3.0"
        },
        {
            "id": "vicksburg",
            "title": "Siege of Vicksburg",
            "url": "images/siege_of_vicksburg.jpg",
            "credit": "Kurz & Allison",
            "license": "Public Domain",
            "source": "Library of Congress",
            "note": "Download from: https://www.battlefields.org/learn/maps/battle-vicksburg-tomlinson",
            "mapUrl": "https://commons.wikimedia.org/wiki/Special:Redirect/file/VicksburgCampaignDecember62March63.png?width=900",
            "mapCredit": "Map by Hal Jespersen, cwmaps.com",
            "mapLicense": "CC BY 3.0"
        },
        {
            "id": "gettysburg",
            "title": "Battle of Gettysburg",
            "url": "images/battle_of_gettysburg.jpg",
            "credit": "Thure de Thulstrup",
            "license": "Public Domain",
            "source": "Library of Congress",
            "mapUrl": "https://commons.wikimedia.org/wiki/Special:Redirect/file/Gettysburg_Battle_Map_Day3.png?width=900",
            "mapCredit": "Map by Hal Jespersen, cwmaps.com",
            "mapLicense": "CC BY 3.0"
        },
        {
            "id": "chickamauga",
            "title": "Battle of Chickamauga",
            "url": "images/battle_of_chickamauga.jpg",
            "credit": "Kurz & Allison",
            "license": "Public Domain",
            "source": "Library of Congress",
            "mapUrl": "https://commons.wikimedia.org/wiki/Special:Redirect/file/Chickamauga_Sep20.png?width=900",
            "mapCredit": "Map by Hal Jespersen, cwmaps.com",
            "mapLicense": "CC BY 3.0"
        },
        {
            "id": "wilderness",
            "title": "Battle of the Wilderness",
            "url": "images/battle_of_the_wilderness.jpg",
            "credit": "Kurz & Allison",
            "license": "Public Domain",
            "source": "Library of Congress",
            "mapUrl": "https://commons.wikimedia.org/wiki/Special:Redirect/file/Wilderness_May5_0700.png?width=900",
            "mapCredit": "Map by Hal Jespersen, cwmaps.com",
            "mapLicense": "CC BY 3.0"
        },
        {
            "id": "atlanta",
            "title": "Battle of Atlanta",
            "url": "images/battle_of_atlanta.jpg",
            "credit": "Kurz & Allison",
            "license": "Public Domain",
            "source": "Library of Congress",
            "mapUrl": "https://commons.wikimedia.org/wiki/Special:Redirect/file/Atlanta_Campaign_May7-Jul2.png?width=900",
            "mapCredit": "Map by Hal Jespersen, cwmaps.com",
            "mapLicense": "CC BY 3.0"
        },
        {
            "id": "shermans_march",
            "title": "Sherman's March to the Sea",
            "url": "images/shermans_march.jpg",
            "credit": "F.O.C. Darley & Alexander Hay Ritchie",
            "license": "Public Domain",
            "source": "Wikimedia Commons",
            "mapUrl": "https://commons.wikimedia.org/wiki/Special:Redirect/file/Shermans_march_through_Georgia_and_the_Carolinas_map-en.svg?width=900",
            "mapCredit": "Map by Sting, Wikimedia Commons",
            "mapLicense": "CC BY 3.0"
        },
        {
            "id": "appomattox",
            "title": "Surrender at Appomattox",
            "url": "images/surrender_appomattox.jpg",
            "credit": "Tom Lovell",
            "license": "Public Domain",
            "source": "National Archives",
            "mapUrl": "https://commons.wikimedia.org/wiki/Special:Redirect/file/Appomattox_Campaign_Overview.png?width=900",
            "mapCredit": "Map by Hal Jespersen, cwmaps.com",
            "mapLicense": "CC BY 3.0"
        }
    ]</script>

    <!-- Google Fonts - Optimized Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Crimson+Pro:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Crimson+Pro:wght@400;500;600&display=swap" rel="stylesheet"></noscript>

    <script>
    // Theme functions
        function toggleTheme() {
            var html = document.documentElement;
            var currentTheme = html.getAttribute('data-theme');
            var newTheme = currentTheme === 'light' ? 'dark' : 'light';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            var toggleBtn = document.getElementById('themeToggle');
            if (toggleBtn) {
                toggleBtn.querySelector('.theme-icon').textContent = newTheme === 'light' ? '\u{1F319}' : '\u2600\uFE0F';
                toggleBtn.setAttribute('aria-label', 'Switch to ' + (newTheme === 'light' ? 'dark' : 'light') + ' theme');
            }
        }

        function initializeTheme() {
            var savedTheme = localStorage.getItem('theme') || 'dark';
            var html = document.documentElement;

            html.setAttribute('data-theme', savedTheme);

            var toggleBtn = document.getElementById('themeToggle');
            if (toggleBtn) {
                toggleBtn.querySelector('.theme-icon').textContent = savedTheme === 'light' ? '\u{1F319}' : '\u2600\uFE0F';
                toggleBtn.setAttribute('aria-label', 'Switch to ' + (savedTheme === 'light' ? 'dark' : 'light') + ' theme');
            }
        }
    </script>

    <!-- Stylesheet -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body onload="initializeTheme()">
    <!-- Skip Navigation Link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Main Navigation Bar -->
    <nav class="main-navbar" role="navigation" aria-label="Main navigation">
        <div class="navbar-content">
            <div class="navbar-brand">
                <h1 class="nav-game-title">&#x2694;&#xFE0F; Civil War Simulation</h1>
                <span class="nav-subtitle">Educational Edition</span>
            </div>

            <div class="navbar-controls">
                <button class="nav-btn primary-action" id="campaignLogNavBtn" style="display: none;" aria-label="View campaign log" title="Campaign Log">
                    &#x1F4CA;
                </button>
                <button class="nav-btn help-btn" id="helpToggleBtn" style="display: none;" aria-label="Toggle help tips" title="Help">
                    ?
                </button>

                <div class="settings-dropdown">
                    <button class="nav-btn settings-btn" id="settingsBtn" aria-label="Open menu" aria-expanded="false" title="Menu">
                        &#x22EF;
                    </button>
                    <div class="settings-menu" id="settingsMenu" role="menu" aria-labelledby="settingsBtn">
                        <div class="menu-section">
                            <div class="menu-section-title">Appearance</div>
                            <button class="settings-item theme-toggle-item" id="themeToggle" onclick="toggleTheme()" role="menuitem" aria-label="Switch theme">
                                <span class="menu-icon theme-icon">&#x2600;&#xFE0F;</span> <span class="theme-text">Light Theme</span>
                            </button>
                        </div>

                        <div class="settings-divider" id="gameActionsDiv" style="display: none;"></div>
                        <div class="menu-section" id="gameActionsSection" style="display: none;">
                            <div class="menu-section-title">Game</div>
                            <button class="settings-item danger-item" id="startOverNavBtn" role="menuitem">
                                <span class="menu-icon">&#x1F504;</span> Start Over
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Help Bar - contextual tips (toggleable) -->
    <div class="help-bar" id="helpBar" style="display:none;" role="status" aria-live="polite">
        <span class="help-bar-icon">&#x1F4A1;</span>
        <span class="help-bar-text" id="helpBarText">Welcome! Click Continue to move through each battle step by step.</span>
        <button class="help-bar-close" id="helpBarClose" aria-label="Close help">&times;</button>
    </div>

    <!-- Tutorial Overlay -->
    <div class="tutorial-overlay" id="tutorialOverlay" style="display:none;">
        <div class="tutorial-backdrop" id="tutorialBackdrop"></div>
        <div class="tutorial-tooltip" id="tutorialTooltip">
            <div class="tutorial-step-count" id="tutorialStepCount"></div>
            <p class="tutorial-text" id="tutorialText"></p>
            <div class="tutorial-actions">
                <button class="tutorial-skip" id="tutorialSkip">Skip Tutorial</button>
                <button class="tutorial-next btn-primary" id="tutorialNext">Next</button>
            </div>
        </div>
    </div>

    <main class="game-container" id="main-content" role="main" aria-label="Civil War Battle Simulation Game">

        <!-- ======================== -->
        <!-- INTRO SPLASH SCREEN      -->
        <!-- ======================== -->
        <div class="screen" id="introSplash" style="display:none;" role="region" aria-label="Welcome to the Civil War Simulation">
            <div class="splash-hero">
                <div class="splash-icon" aria-hidden="true">&#x2694;&#xFE0F;</div>
                <h2 class="splash-title">Civil War Battle Simulation</h2>
                <p class="splash-tagline">Step into American history and experience the decisions that shaped a nation.</p>
            </div>

            <div class="splash-overview">
                <p class="splash-intro">From 1861 to 1865, the United States fought its deadliest war. Over 13 major battles, you'll make real decisions, hear from the people who lived through it, and discover how this war changed America forever.</p>
            </div>

            <div class="splash-modes">
                <div class="splash-mode-card">
                    <div class="splash-mode-icon" aria-hidden="true">&#x1F4DC;</div>
                    <h3 class="splash-mode-title">Historical Mode</h3>
                    <p class="splash-mode-desc">Walk through each battle step by step. Read real accounts from soldiers, nurses, and civilians. Make the same choices commanders faced, then reflect on what you've learned.</p>
                </div>
                <div class="splash-mode-card">
                    <div class="splash-mode-icon" aria-hidden="true">&#x1F3AF;</div>
                    <h3 class="splash-mode-title">Free-play Mode</h3>
                    <p class="splash-mode-desc">Take command and make your own strategic choices. Build momentum, face unpredictable events, and see if you can change the course of history.</p>
                </div>
            </div>

            <div class="splash-learn">
                <h3 class="splash-learn-title">What You'll Discover</h3>
                <ul class="splash-learn-list">
                    <li>Why people on both sides chose to fight &mdash; and at what cost</li>
                    <li>Which battles turned the tide of the war and why they mattered</li>
                    <li>How new technology and tactics changed warfare forever</li>
                    <li>The stories of soldiers, women, Black Americans, and Indigenous peoples</li>
                    <li>How military events shaped political decisions that still affect us today</li>
                </ul>
            </div>

            <div class="splash-actions">
                <button class="btn-primary splash-start-btn" id="splashStartBtn">Let's Get Started</button>
            </div>
        </div>

        <!-- ======================== -->
        <!-- MODE SELECTION SCREEN    -->
        <!-- ======================== -->
        <div class="screen" id="modeSelection" role="region" aria-label="Choose game mode">
            <h2 class="section-title">&#x2694;&#xFE0F; Civil War Battle Simulation</h2>
            <p class="subtitle">Experience the American Civil War (1861-1865) through 13 major battles</p>

            <div class="mode-cards">
                <div class="mode-card historical-mode-card" id="historicalModeCard" role="button" tabindex="0">
                    <div class="mode-icon">&#x1F4DC;</div>
                    <h3 class="mode-title">Historical Mode</h3>
                    <p class="mode-description">Experience the war as it actually happened. Make decisions, read primary sources, and reflect on what you learn.</p>
                    <ul class="mode-features">
                        <li>Interactive walkthrough of all 13 battles</li>
                        <li>Primary source quotes and technology highlights</li>
                        <li>Reflection questions for each battle</li>
                        <li>Download your responses as a PDF</li>
                    </ul>
                    <div class="mode-badge">Start Here</div>
                </div>

                <div class="mode-card freeplay-mode-card" id="freeplayModeCard" role="button" tabindex="0">
                    <div class="mode-icon">&#x1F3AF;</div>
                    <h3 class="mode-title">Free-play Mode</h3>
                    <p class="mode-description">Make your own strategic decisions and change the course of history. Fog of war adds unpredictable events to every battle.</p>
                    <ul class="mode-features">
                        <li>Choose strategies for each battle</li>
                        <li>Fog of war - random events change outcomes</li>
                        <li>Historical events that shaped real battles</li>
                        <li>Compete on the class leaderboard</li>
                    </ul>
                    <div class="mode-lock" id="freeplayLock">
                        &#x1F512; Complete Historical Mode to unlock
                    </div>
                </div>
            </div>

            <!-- Resume saved game prompt -->
            <div class="resume-prompt" id="resumePrompt" style="display: none;">
                <p class="resume-text">You have a saved game in progress.</p>
                <div class="resume-actions">
                    <button class="btn-primary" id="resumeBtn">Continue Where You Left Off</button>
                    <button class="btn-secondary" id="newGameBtn">Start Fresh</button>
                </div>
            </div>
        </div>

        <!-- ======================== -->
        <!-- SIDE SELECTION SCREEN    -->
        <!-- (includes name entry for historical mode) -->
        <!-- ======================== -->
        <div class="screen" id="sideSelection" style="display:none;" role="region" aria-label="Choose your side">
            <h2 class="section-title" id="sideSelectionTitle">Choose Your Side</h2>
            <p class="subtitle" id="sideSelectionSubtitle">Experience these battles from the perspective you choose</p>

            <!-- Name entry (historical mode only) -->
            <div class="name-inline" id="nameInlineSection" style="display:none;">
                <div class="name-fields">
                    <div class="name-field">
                        <label for="firstNameInput" class="name-field-label">First Name</label>
                        <input type="text" id="firstNameInput" class="name-field-input" placeholder="Sarah" maxlength="20" autocomplete="given-name" aria-label="Your first name">
                    </div>
                    <div class="name-field name-field-initial">
                        <label for="lastInitialInput" class="name-field-label">Last Initial</label>
                        <input type="text" id="lastInitialInput" class="name-field-input initial-input" placeholder="J" maxlength="1" aria-label="Your last initial">
                    </div>
                </div>
            </div>

            <!-- Difficulty / Reading Level Toggle (historical mode only) -->
            <div class="difficulty-selector" id="difficultySelectorSection">
                <div class="difficulty-label">Reading Level</div>
                <div class="difficulty-pills" role="radiogroup" aria-label="Select reading level">
                    <button class="difficulty-pill" data-level="beginner" role="radio" aria-checked="false">Beginner</button>
                    <button class="difficulty-pill active" data-level="intermediate" role="radio" aria-checked="true">Intermediate</button>
                    <button class="difficulty-pill" data-level="advanced" role="radio" aria-checked="false">Advanced</button>
                </div>
                <div class="difficulty-hint" id="difficultyHint">Standard text, some writing help</div>
            </div>

            <div class="sides-container">
                <div class="side-card union-card" id="unionCard" role="button" tabindex="0" aria-label="Play as the Union">
                    <span class="side-flag" aria-hidden="true">&#x1F1FA;&#x1F1F8;</span>
                    <h2 class="side-name">Union (The North)</h2>
                    <p class="side-description">
                        <strong>&#x1F3ED; Industrial Powerhouse</strong><br>
                        Command President Lincoln's forces fighting to keep America united and end slavery forever.
                    </p>
                    <p class="soldier-count" id="unionSoldierCount"></p>
                </div>

                <div class="side-card confederacy-card" id="confederacyCard" role="button" tabindex="0" aria-label="Play as the Confederacy">
                    <span class="side-flag" aria-hidden="true">&#x1F3F4;</span>
                    <h2 class="side-name">Confederacy (The South)</h2>
                    <p class="side-description">
                        <strong>&#x2694;&#xFE0F; Defending the South</strong><br>
                        Fight for Southern independence. Outnumbered but with skilled generals and home territory advantage.
                    </p>
                    <p class="soldier-count" id="confederacySoldierCount"></p>
                </div>
            </div>

            <button class="back-btn" id="backToModeBtn">&#x2190; Back to Mode Selection</button>
        </div>

        <!-- ============================== -->
        <!-- LEADER LETTER SCREEN           -->
        <!-- ============================== -->
        <div class="screen" id="leaderLetterScreen" style="display:none;" role="region" aria-label="Message from your leader">
            <div class="letter-wrapper">
                <div class="letter-paper">
                    <div class="letter-header-section">
                        <div class="letter-seal" id="letterSeal" aria-hidden="true"></div>
                        <div class="letter-from" id="letterFrom"></div>
                        <div class="letter-date" id="letterDate"></div>
                    </div>
                    <div class="letter-salutation" id="letterSalutation"></div>
                    <div class="letter-body" id="letterBody"></div>
                    <div class="letter-closing" id="letterClosing"></div>
                    <div class="letter-signature" id="letterSignature"></div>
                    <div class="letter-title" id="letterTitle"></div>
                </div>
            </div>
            <div class="letter-actions">
                <button class="btn-primary letter-begin-btn" id="beginJourneyBtn">Begin Your Journey</button>
            </div>
        </div>

        <!-- ================================= -->
        <!-- HISTORICAL MODE: BATTLE SCREEN    -->
        <!-- ================================= -->
        <div class="screen" id="historicalScreen" style="display:none;" role="region" aria-label="Historical battle">
            <!-- Progress bar -->
            <div class="battle-progress">
                <div class="progress-label" id="historicalProgressLabel">Battle 1 of 13</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="historicalProgressFill" style="width: 7.7%"></div>
                </div>
            </div>

            <!-- Step indicator pills -->
            <div class="step-pills" id="stepPills">
                <span class="step-pill active">1. Briefing</span>
                <span class="step-pill">2. Your Call</span>
                <span class="step-pill">3. What Happened</span>
                <span class="step-pill">4. Reflect</span>
            </div>

            <!-- Battle header -->
            <div class="battle-header">
                <h2 class="battle-name" id="histBattleName"></h2>
                <div class="battle-meta">
                    <span class="battle-date" id="histBattleDate"></span>
                    <span class="battle-location" id="histBattleLocation"></span>
                </div>
            </div>

            <!-- Battle visuals: Artwork + Map tabs -->
            <div class="battle-visuals">
                <div class="visual-tabs">
                    <button class="visual-tab active" data-tab="artwork" onclick="switchVisualTab(this, 'histArtwork', 'histMap')">Artwork</button>
                    <button class="visual-tab" data-tab="map" onclick="switchVisualTab(this, 'histMap', 'histArtwork')">Battle Map</button>
                </div>
                <div class="battle-image-container" id="histArtwork"></div>
                <div class="battle-map-container" id="histMap" style="display:none;"></div>
            </div>

            <!-- Narrative sections - revealed progressively -->
            <div class="narrative-sections" id="narrativeSections">

                <!-- Section 1: Intel Report -->
                <div class="narrative-section intel-section" id="sectionIntel">
                    <h3 class="narrative-heading">&#x1F4CB; Intel Report</h3>
                    <div class="intel-grid" id="histIntelGrid">
                        <!-- Rendered by JS -->
                    </div>
                </div>

                <!-- Section 2: The Situation -->
                <div class="narrative-section situation-section" id="sectionSituation" style="display:none;">
                    <h3 class="narrative-heading">&#x1F5FA;&#xFE0F; The Situation</h3>
                    <p class="narrative-text" id="histSituation"></p>
                </div>

                <!-- Section 3: What Would You Do? -->
                <div class="narrative-section wwyd-section" id="sectionWWYD" style="display:none;">
                    <h3 class="narrative-heading">&#x1F914; What Would You Do?</h3>
                    <p class="wwyd-prompt" id="histWWYDPrompt"></p>
                    <div class="wwyd-options" id="histWWYDOptions" role="group" aria-label="Choose what you would do">
                        <!-- Rendered by JS -->
                    </div>
                </div>

                <!-- WWYD Feedback (shown after choice, before What Happened) -->
                <div class="wwyd-feedback" id="wwydFeedback" style="display:none;">
                    <h4 class="feedback-heading">Your Choice vs. History</h4>
                    <div class="feedback-your-choice">
                        <div class="feedback-label">You chose:</div>
                        <div class="feedback-choice-text" id="feedbackChoiceText"></div>
                    </div>
                    <div class="feedback-badge" id="feedbackBadge"></div>
                    <div class="feedback-historical" id="feedbackHistorical" style="display:none;">
                        <div class="feedback-label">The historical decision:</div>
                        <div class="feedback-choice-text" id="feedbackHistoricalText"></div>
                    </div>
                    <p class="feedback-detail" id="feedbackDetail"></p>
                </div>

                <!-- Section 4: What Really Happened + Tech -->
                <div class="narrative-section happened-section" id="sectionHappened" style="display:none;">
                    <h3 class="narrative-heading">&#x1F4D6; What Really Happened</h3>
                    <p class="narrative-text" id="histWhatHappened"></p>

                    <div class="outcome-box" id="histOutcomeBox">
                        <div class="outcome-label">Historical Outcome</div>
                        <div class="outcome-result" id="histOutcome"></div>
                        <div class="outcome-casualties" id="histCasualties"></div>
                    </div>

                    <div class="tech-highlight" id="histTechBox">
                        <div class="tech-label">&#x2699;&#xFE0F; Technology Spotlight</div>
                        <div class="tech-name" id="histTechName"></div>
                        <p class="tech-description" id="histTechDesc"></p>
                    </div>
                </div>

                <!-- Section 5: A Voice From the War -->
                <div class="narrative-section voice-section" id="sectionVoice" style="display:none;">
                    <h3 class="narrative-heading">&#x1F4AC; A Voice From the War</h3>
                    <blockquote class="voice-quote" id="histVoiceQuote"></blockquote>
                    <div class="voice-attribution" id="histVoiceAttribution"></div>
                    <div class="voice-source" id="histVoiceSource"></div>
                    <div class="voice-explainer" id="histVoiceExplainer" style="display:none;"></div>
                </div>

                <!-- Section 6: The Bigger Picture -->
                <div class="narrative-section bigger-picture-section" id="sectionBigPicture" style="display:none;">
                    <h3 class="narrative-heading">&#x1F30D; The Bigger Picture</h3>
                    <p class="narrative-text" id="histBigPicture"></p>

                    <div class="key-fact-box">
                        <div class="key-fact-label">&#x1F4A1; Did You Know?</div>
                        <p class="key-fact-text" id="histKeyFact"></p>
                    </div>

                    <div class="perspectives-container" id="histPerspectives"></div>
                </div>

                <!-- Section 7: Reflect -->
                <div class="narrative-section reflect-section" id="sectionReflect" style="display:none;">
                    <h3 class="narrative-heading">&#x270D;&#xFE0F; Reflect</h3>
                    <p class="reflect-prompt" id="histReflectPrompt"></p>

                    <!-- Reflection scaffolding - shown based on difficulty level -->
                    <div class="reflect-scaffolding" id="reflectScaffolding" style="display:none;">
                        <!-- Beginner/Intermediate: clickable sentence starters -->
                        <div class="starter-chips" id="starterChips" style="display:none;">
                            <div class="starter-label" id="starterLabel">Click a sentence starter to begin:</div>
                            <div class="starter-chip-list" id="starterChipList" role="group" aria-label="Sentence starters">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        <!-- Advanced: RACE reminder -->
                        <div class="race-reminder" id="raceReminder" style="display:none;">
                            <div class="race-title">Use the RACE method:</div>
                            <div class="race-steps">
                                <div class="race-step"><span class="race-letter">R</span><span class="race-desc">Restate the question</span></div>
                                <div class="race-step"><span class="race-letter">A</span><span class="race-desc">Answer the question</span></div>
                                <div class="race-step"><span class="race-letter">C</span><span class="race-desc">Cite evidence from what you read</span></div>
                                <div class="race-step"><span class="race-letter">E</span><span class="race-desc">Explain your thinking</span></div>
                            </div>
                            <div class="race-note">Write in complete sentences.</div>
                        </div>
                    </div>

                    <!-- Teacher tip - expandable coaching hint -->
                    <div class="teacher-tip" id="teacherTip" style="display:none;">
                        <button class="teacher-tip-toggle" id="teacherTipToggle" type="button" aria-expanded="false" aria-controls="teacherTipContent">
                            Need a hint?
                        </button>
                        <div class="teacher-tip-content" id="teacherTipContent" style="display:none;">
                            <p class="teacher-tip-text" id="teacherTipText"></p>
                        </div>
                    </div>

                    <textarea class="reflect-input" id="histReflectInput" rows="4" placeholder="Write your thoughts here..." aria-label="Your reflection"></textarea>
                </div>
            </div>

            <!-- Navigation buttons -->
            <div class="narrative-nav">
                <button class="btn-primary" id="narrativeContinueBtn">Continue</button>
            </div>
        </div>

        <!-- ============================= -->
        <!-- FREE-PLAY: BATTLE BRIEFING    -->
        <!-- ============================= -->
        <div class="screen" id="freeplayBriefing" style="display:none;" role="region" aria-label="Battle briefing and strategy selection">
            <div class="freeplay-status">
                <div class="battle-progress">
                    <div class="progress-label" id="freeplayProgressLabel">Battle 1 of 13</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="freeplayProgressFill" style="width: 7.7%"></div>
                    </div>
                </div>
                <div class="war-stats">
                    <div class="stat-item">
                        <span class="stat-label">Wins</span>
                        <span class="stat-value" id="statWins">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Losses</span>
                        <span class="stat-value" id="statLosses">0</span>
                    </div>
                    <div class="stat-item momentum-stat">
                        <span class="stat-label">Momentum</span>
                        <span class="stat-value" id="statMomentum">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Army</span>
                        <span class="stat-value" id="statSoldiers">1,500,000</span>
                    </div>
                </div>
            </div>

            <div class="battle-header">
                <h2 class="battle-name" id="fpBattleName"></h2>
                <div class="battle-meta">
                    <span class="battle-date" id="fpBattleDate"></span>
                    <span class="battle-location" id="fpBattleLocation"></span>
                </div>
            </div>

            <div class="battle-visuals">
                <div class="visual-tabs">
                    <button class="visual-tab active" data-tab="artwork" onclick="switchVisualTab(this, 'fpArtwork', 'fpMap')">Artwork</button>
                    <button class="visual-tab" data-tab="map" onclick="switchVisualTab(this, 'fpMap', 'fpArtwork')">Battle Map</button>
                </div>
                <div class="battle-image-container" id="fpArtwork"></div>
                <div class="battle-map-container" id="fpMap" style="display:none;"></div>
            </div>

            <div class="briefing-text">
                <h3 class="briefing-label">Situation Report</h3>
                <p class="briefing-content" id="fpBriefing"></p>
            </div>

            <!-- Historical event notice (if applicable) -->
            <div class="historical-event-notice" id="fpHistEventNotice" style="display:none;">
                <div class="hist-event-label">&#x1F4DC; Historical Event</div>
                <p class="hist-event-text" id="fpHistEventText"></p>
            </div>

            <div class="strategy-choices" role="group" aria-label="Choose your strategy">
                <h3 class="choices-heading">Choose Your Strategy</h3>
                <div class="strategy-list" id="strategyList"></div>
            </div>
        </div>

        <!-- ============================= -->
        <!-- FREE-PLAY: BATTLE RESULTS     -->
        <!-- ============================= -->
        <div class="screen" id="freeplayResults" style="display:none;" role="region" aria-label="Battle results">
            <div class="result-banner" id="resultBanner">
                <h2 class="result-title" id="resultTitle">VICTORY!</h2>
            </div>

            <div class="result-details">
                <p class="result-outcome" id="resultOutcome"></p>

                <!-- Fog of War / Historical Event display -->
                <div class="fog-of-war-section" id="fogOfWarSection" style="display:none;">
                    <div class="fog-event" id="fogEventDisplay">
                        <span class="fog-label">&#x1F32B;&#xFE0F; Fog of War:</span>
                        <span class="fog-text" id="fogEventText"></span>
                        <span class="fog-mod" id="fogEventMod"></span>
                    </div>
                    <div class="hist-event" id="histEventDisplay" style="display:none;">
                        <span class="fog-label">&#x1F4DC; Historical Event:</span>
                        <span class="fog-text" id="histEventText"></span>
                        <span class="fog-mod" id="histEventMod"></span>
                    </div>
                </div>

                <!-- Power breakdown -->
                <div class="power-breakdown" id="powerBreakdown">
                    <div class="power-label">Battle Power Breakdown</div>
                    <div class="power-items" id="powerItems">
                        <!-- Rendered by JS -->
                    </div>
                    <div class="power-total">
                        <span>Effective Power:</span>
                        <span id="powerTotal">0</span>
                        <span class="power-vs">vs Difficulty:</span>
                        <span id="powerDifficulty">0</span>
                    </div>
                </div>

                <div class="result-stats">
                    <div class="result-stat">
                        <span class="result-stat-label">Casualties</span>
                        <span class="result-stat-value" id="resultCasualties">25,000</span>
                    </div>
                    <div class="result-stat">
                        <span class="result-stat-label">Score</span>
                        <span class="result-stat-value" id="resultScore">+400</span>
                    </div>
                    <div class="result-stat">
                        <span class="result-stat-label">Momentum</span>
                        <span class="result-stat-value" id="resultMomentum">+2</span>
                    </div>
                    <div class="result-stat">
                        <span class="result-stat-label">Army Size</span>
                        <span class="result-stat-value" id="resultArmy">975,000</span>
                    </div>
                </div>

                <!-- Historical context - what really happened -->
                <div class="historical-context-box" id="histContextBox" style="display:none;">
                    <div class="hist-context-label">&#x1F4D6; What Really Happened</div>
                    <p class="hist-context-text" id="histContextText"></p>
                    <div class="hist-context-outcome" id="histContextOutcome"></div>
                </div>

                <div class="momentum-meter">
                    <div class="momentum-label">War Momentum</div>
                    <div class="momentum-bar">
                        <div class="momentum-negative-zone"></div>
                        <div class="momentum-positive-zone"></div>
                        <div class="momentum-marker" id="momentumMarker" style="left: 50%"></div>
                    </div>
                    <div class="momentum-labels">
                        <span>Enemy Winning</span>
                        <span>Even</span>
                        <span>You're Winning</span>
                    </div>
                </div>
            </div>

            <button class="btn-primary" id="nextBattleBtn">Continue to Next Battle</button>
        </div>

        <!-- ============================= -->
        <!-- CAMPAIGN LOG MODAL            -->
        <!-- ============================= -->
        <div class="modal" id="campaignLogModal" style="display:none;">
            <div class="modal-container">
                <div class="modal-header">
                    <h2 class="modal-title">Campaign Progress</h2>
                    <button class="modal-close" id="closeLogBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Tab switcher: Progress / War Map -->
                    <div class="log-tabs" id="logTabs">
                        <button class="log-tab active" data-log-tab="progress" id="logTabProgress">Progress</button>
                        <button class="log-tab" data-log-tab="warmap" id="logTabWarMap">War Map</button>
                    </div>

                    <!-- Progress tab -->
                    <div class="log-tab-content" id="logProgressContent">
                        <div class="campaign-overview">
                            <div class="progress-summary">
                                <div class="summary-stat">
                                    <div class="stat-number" id="logBattlesFought">0</div>
                                    <div class="stat-label">Battles</div>
                                </div>
                                <div class="summary-stat">
                                    <div class="stat-number" id="logWins">0</div>
                                    <div class="stat-label">Wins</div>
                                </div>
                                <div class="summary-stat">
                                    <div class="stat-number" id="logScore">0</div>
                                    <div class="stat-label">Score</div>
                                </div>
                                <div class="summary-stat">
                                    <div class="stat-number" id="logMomentum">0</div>
                                    <div class="stat-label">Momentum</div>
                                </div>
                            </div>
                        </div>
                        <div class="battle-timeline" id="logTimeline"></div>
                    </div>

                    <!-- War Map tab (ArcGIS embed) -->
                    <div class="log-tab-content" id="logWarMapContent" style="display:none;">
                        <div class="warmap-container" id="warmapContainer">
                            <p class="warmap-hint">Interactive map of Civil War battle locations. Zoom and click markers for details.</p>
                            <div class="warmap-frame-wrapper" id="warmapFrameWrapper">
                                <!-- iframe loaded on first tab click to save bandwidth -->
                            </div>
                            <p class="warmap-credit">Map data: <a href="https://www.arcgis.com/apps/mapviewer/index.html?webmap=bd513e724e0e4a81b09790c6a47a072a" target="_blank" rel="noopener">ArcGIS / Esri</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================= -->
        <!-- END GAME SUMMARY              -->
        <!-- ============================= -->
        <div class="screen" id="endGameScreen" style="display:none;" role="region" aria-label="Game results">
            <div class="outcome-banner" id="endBanner">
                <h1 class="outcome-title" id="endTitle">VICTORY!</h1>
                <p class="outcome-subtitle" id="endSubtitle">The Union is Preserved</p>
            </div>

            <div id="endContent"></div>

            <!-- PDF export button (historical mode) -->
            <div id="pdfExportSection" class="pdf-export-section" style="display:none;">
                <button class="btn-primary pdf-export-btn" id="exportPdfBtn">&#x1F4C4; Download Response Sheet (PDF)</button>
                <p class="pdf-hint">Opens a printable page. Use Print &rarr; Save as PDF to submit on Canvas.</p>
            </div>

            <!-- Scoreboard (free-play only) -->
            <div id="scoreboardSection" class="scoreboard-section" style="display:none;"></div>

            <!-- Class Leaderboard (free-play, Firebase) -->
            <div id="classLeaderboardSection" class="class-leaderboard-section" style="display:none;">
                <!-- Room code entry -->
                <div class="room-code-form" id="roomCodeForm">
                    <h3 class="room-code-title">&#x1F3EB; Join Class Leaderboard</h3>
                    <p class="room-code-desc">Enter the room code your teacher gave you to see the class rankings.</p>
                    <div class="room-code-input-row">
                        <input type="text" id="roomCodeInput" class="room-code-input"
                               placeholder="e.g. CWPER1" maxlength="12"
                               autocomplete="off" spellcheck="false"
                               aria-label="Class room code">
                        <button class="btn-primary room-code-join-btn" id="roomCodeJoinBtn">Join</button>
                    </div>
                    <div class="room-code-error" id="roomCodeError" style="display:none;"></div>
                </div>

                <!-- Class leaderboard display (shown after joining) -->
                <div class="class-leaderboard-display" id="classLeaderboardDisplay" style="display:none;">
                    <div class="class-leaderboard-header">
                        <h3 class="class-leaderboard-title">&#x1F3C6; Class Leaderboard</h3>
                        <div class="class-room-info">
                            <span class="class-room-label">Room:</span>
                            <span class="class-room-code" id="classRoomCodeLabel"></span>
                            <button class="class-room-leave" id="leaveRoomBtn" title="Leave room">&times;</button>
                        </div>
                    </div>
                    <div class="class-leaderboard-status" id="classLeaderboardStatus"></div>
                    <div class="class-leaderboard-table-wrapper" id="classLeaderboardTable"></div>
                </div>
            </div>

            <!-- Image Credits -->
            <div class="image-credits-section">
                <button class="credits-toggle" id="creditsToggle" aria-expanded="false" aria-controls="creditsContent" type="button">
                    <span class="credits-icon">&#x1F4F7;</span>
                    <span class="credits-text">View Image Credits</span>
                    <span class="credits-arrow">&#x25BC;</span>
                </button>

                <div class="credits-content" id="creditsContent" aria-hidden="true">
                    <h3>Image Credits &amp; Sources</h3>
                    <p class="credits-note">All images used in this educational simulation are in the public domain.</p>
                    <div class="credits-grid">
                        <div class="credit-item"><strong>Fort Sumter:</strong><br>Library of Congress, Public Domain</div>
                        <div class="credit-item"><strong>Battle of Bull Run:</strong><br>Library of Congress, Public Domain</div>
                        <div class="credit-item"><strong>Battle of Shiloh:</strong><br>Library of Congress, Public Domain</div>
                        <div class="credit-item"><strong>Battle of Antietam:</strong><br>National Archives, Public Domain</div>
                        <div class="credit-item"><strong>Battle of Fredericksburg:</strong><br>Library of Congress, Public Domain</div>
                        <div class="credit-item"><strong>Battle of Chancellorsville:</strong><br>National Archives, Public Domain</div>
                        <div class="credit-item"><strong>Siege of Vicksburg:</strong><br>Library of Congress, Public Domain</div>
                        <div class="credit-item"><strong>Battle of Gettysburg:</strong><br>Library of Congress, Public Domain</div>
                        <div class="credit-item"><strong>Battle of Chickamauga:</strong><br>Library of Congress, Public Domain</div>
                        <div class="credit-item"><strong>Battle of the Wilderness:</strong><br>Library of Congress, Public Domain</div>
                        <div class="credit-item"><strong>Battle of Atlanta:</strong><br>Library of Congress, Public Domain</div>
                        <div class="credit-item"><strong>Sherman's March:</strong><br>Library of Congress, Public Domain</div>
                        <div class="credit-item"><strong>Surrender at Appomattox:</strong><br>National Archives, Public Domain</div>
                    </div>
                </div>
            </div>

            <div class="end-actions">
                <button class="btn-primary" id="playAgainBtn">Play Again</button>
                <button class="btn-secondary" id="backToMenuBtn">Back to Menu</button>
            </div>
        </div>

    </main>

    <!-- Firebase SDK (compat for non-module use) - game works without it -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

    <!-- JavaScript - Data files first, then logic, then UI, then app init -->
    <script src="js/data/battles.js"></script>
    <script src="js/data/leaders.js"></script>
    <script src="js/data/maps.js"></script>
    <script src="js/game.js"></script>
    <script src="js/firebase-leaderboard.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js"></script>

    <!-- Version Display -->
    <div class="version-info">
        <span>Civil War Battle Simulation v3.7.0</span>
    </div>
</body>
</html>
